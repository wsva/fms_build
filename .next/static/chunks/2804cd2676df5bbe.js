(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,22980,e=>{"use strict";e.s(["default",()=>eA],22980);var t,r=e.i(43476),a=e.i(71645);e.i(47167);var s=Symbol.for("immer-nothing"),i=Symbol.for("immer-draftable"),n=Symbol.for("immer-state");function o(e){for(var t=arguments.length,r=Array(t>1?t-1:0),a=1;a<t;a++)r[a-1]=arguments[a];throw Error("[Immer] minified error nr: ".concat(e,". Full error at: https://bit.ly/3cXEKWf"))}var l=Object.getPrototypeOf;function c(e){return!!e&&!!e[n]}function d(e){var t;return!!e&&(f(e)||Array.isArray(e)||!!e[i]||!!(null==(t=e.constructor)?void 0:t[i])||v(e)||y(e))}var u=Object.prototype.constructor.toString();function f(e){if(!e||"object"!=typeof e)return!1;let t=l(e);if(null===t)return!0;let r=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return r===Object||"function"==typeof r&&Function.toString.call(r)===u}function p(e,t){0===m(e)?Reflect.ownKeys(e).forEach(r=>{t(r,e[r],e)}):e.forEach((r,a)=>t(a,r,e))}function m(e){let t=e[n];return t?t.type_:Array.isArray(e)?1:v(e)?2:3*!!y(e)}function h(e,t){return 2===m(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function _(e,t,r){let a=m(e);2===a?e.set(t,r):3===a?e.add(r):e[t]=r}function v(e){return e instanceof Map}function y(e){return e instanceof Set}function g(e){return e.copy_||e.base_}function x(e,t){if(v(e))return new Map(e);if(y(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);let r=f(e);if(!0!==t&&("class_only"!==t||r)){let t=l(e);return null!==t&&r?{...e}:Object.assign(Object.create(t),e)}{let t=Object.getOwnPropertyDescriptors(e);delete t[n];let r=Reflect.ownKeys(t);for(let a=0;a<r.length;a++){let s=r[a],i=t[s];!1===i.writable&&(i.writable=!0,i.configurable=!0),(i.get||i.set)&&(t[s]={configurable:!0,writable:!0,enumerable:i.enumerable,value:e[s]})}return Object.create(l(e),t)}}function b(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return j(e)||c(e)||!d(e)||(m(e)>1&&Object.defineProperties(e,{set:{value:w},add:{value:w},clear:{value:w},delete:{value:w}}),Object.freeze(e),t&&Object.values(e).forEach(e=>b(e,!0))),e}function w(){o(2)}function j(e){return Object.isFrozen(e)}var S={};function P(e){let t=S[e];return t||o(0,e),t}function z(e,t){t&&(P("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function N(e){R(e),e.drafts_.forEach(A),e.drafts_=null}function R(e){e===t&&(t=e.parent_)}function O(e){return t={drafts_:[],parent_:t,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function A(e){let t=e[n];0===t.type_||1===t.type_?t.revoke_():t.revoked_=!0}function D(e,t){t.unfinalizedDrafts_=t.drafts_.length;let r=t.drafts_[0];return void 0!==e&&e!==r?(r[n].modified_&&(N(t),o(4)),d(e)&&(e=B(t,e),t.parent_||C(t,e)),t.patches_&&P("Patches").generateReplacementPatches_(r[n].base_,e,t.patches_,t.inversePatches_)):e=B(t,r,[]),N(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==s?e:void 0}function B(e,t,r){if(j(t))return t;let a=t[n];if(!a)return p(t,(s,i)=>k(e,a,t,s,i,r)),t;if(a.scope_!==e)return t;if(!a.modified_)return C(e,a.base_,!0),a.base_;if(!a.finalized_){a.finalized_=!0,a.scope_.unfinalizedDrafts_--;let t=a.copy_,s=t,i=!1;3===a.type_&&(s=new Set(t),t.clear(),i=!0),p(s,(s,n)=>k(e,a,t,s,n,r,i)),C(e,t,!1),r&&e.patches_&&P("Patches").generatePatches_(a,r,e.patches_,e.inversePatches_)}return a.copy_}function k(e,t,r,a,s,i,n){if(c(s)){let n=B(e,s,i&&t&&3!==t.type_&&!h(t.assigned_,a)?i.concat(a):void 0);if(_(r,a,n),!c(n))return;e.canAutoFreeze_=!1}else n&&r.add(s);if(d(s)&&!j(s)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;B(e,s),(!t||!t.scope_.parent_)&&"symbol"!=typeof a&&(v(r)?r.has(a):Object.prototype.propertyIsEnumerable.call(r,a))&&C(e,s)}}function C(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&b(t,r)}var M={get(e,t){if(t===n)return e;let r=g(e);if(!h(r,t)){var a,s=e,i=r,o=t;let n=L(i,o);return n?"value"in n?n.value:null==(a=n.get)?void 0:a.call(s.draft_):void 0}let l=r[t];return e.finalized_||!d(l)?l:l===I(e.base_,t)?(F(e),e.copy_[t]=T(l,e)):l},has:(e,t)=>t in g(e),ownKeys:e=>Reflect.ownKeys(g(e)),set(e,t,r){let a=L(g(e),t);if(null==a?void 0:a.set)return a.set.call(e.draft_,r),!0;if(!e.modified_){let a=I(g(e),t),s=null==a?void 0:a[n];if(s&&s.base_===r)return e.copy_[t]=r,e.assigned_[t]=!1,!0;if((r===a?0!==r||1/r==1/a:r!=r&&a!=a)&&(void 0!==r||h(e.base_,t)))return!0;F(e),E(e)}return!!(e.copy_[t]===r&&(void 0!==r||t in e.copy_)||Number.isNaN(r)&&Number.isNaN(e.copy_[t]))||(e.copy_[t]=r,e.assigned_[t]=!0,!0)},deleteProperty:(e,t)=>(void 0!==I(e.base_,t)||t in e.base_?(e.assigned_[t]=!1,F(e),E(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0),getOwnPropertyDescriptor(e,t){let r=g(e),a=Reflect.getOwnPropertyDescriptor(r,t);return a?{writable:!0,configurable:1!==e.type_||"length"!==t,enumerable:a.enumerable,value:r[t]}:a},defineProperty(){o(11)},getPrototypeOf:e=>l(e.base_),setPrototypeOf(){o(12)}},U={};function I(e,t){let r=e[n];return(r?g(r):e)[t]}function L(e,t){if(!(t in e))return;let r=l(e);for(;r;){let e=Object.getOwnPropertyDescriptor(r,t);if(e)return e;r=l(r)}}function E(e){!e.modified_&&(e.modified_=!0,e.parent_&&E(e.parent_))}function F(e){e.copy_||(e.copy_=x(e.base_,e.scope_.immer_.useStrictShallowCopy_))}function T(e,r){let a=v(e)?P("MapSet").proxyMap_(e,r):y(e)?P("MapSet").proxySet_(e,r):function(e,r){let a=Array.isArray(e),s={type_:+!!a,scope_:r?r.scope_:t,modified_:!1,finalized_:!1,assigned_:{},parent_:r,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1},i=s,n=M;a&&(i=[s],n=U);let{revoke:o,proxy:l}=Proxy.revocable(i,n);return s.draft_=l,s.revoke_=o,l}(e,r);return(r?r.scope_:t).drafts_.push(a),a}p(M,(e,t)=>{U[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),U.deleteProperty=function(e,t){return U.set.call(this,e,t,void 0)},U.set=function(e,t,r){return M.set.call(this,e[0],t,r,e[0])};var K=new class{createDraft(e){var t;d(e)||o(8),c(e)&&(c(t=e)||o(10,t),e=function e(t){let r;if(!d(t)||j(t))return t;let a=t[n];if(a){if(!a.modified_)return a.base_;a.finalized_=!0,r=x(t,a.scope_.immer_.useStrictShallowCopy_)}else r=x(t,!0);return p(r,(t,a)=>{_(r,t,e(a))}),a&&(a.finalized_=!1),r}(t));let r=O(this),a=T(e,void 0);return a[n].isManual_=!0,R(r),a}finishDraft(e,t){let r=e&&e[n];r&&r.isManual_||o(9);let{scope_:a}=r;return z(a,t),D(void 0,a)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,t){let r;for(r=t.length-1;r>=0;r--){let a=t[r];if(0===a.path.length&&"replace"===a.op){e=a.value;break}}r>-1&&(t=t.slice(r+1));let a=P("Patches").applyPatches_;return c(e)?a(e,t):this.produce(e,e=>a(e,t))}constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,t,r)=>{let a;if("function"==typeof e&&"function"!=typeof t){let r=t;t=e;let a=this;return function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:r;for(var s=arguments.length,i=Array(s>1?s-1:0),n=1;n<s;n++)i[n-1]=arguments[n];return a.produce(e,e=>t.call(this,e,...i))}}if("function"!=typeof t&&o(6),void 0!==r&&"function"!=typeof r&&o(7),d(e)){let s=O(this),i=T(e,void 0),n=!0;try{a=t(i),n=!1}finally{n?N(s):R(s)}return z(s,r),D(a,s)}if(e&&"object"==typeof e)o(1,e);else{if(void 0===(a=t(e))&&(a=e),a===s&&(a=void 0),this.autoFreeze_&&b(a,!0),r){let t=[],s=[];P("Patches").generateReplacementPatches_(e,a,t,s),r(t,s)}return a}},this.produceWithPatches=(e,t)=>{let r,a;if("function"==typeof e){var s=this;return function(t){for(var r=arguments.length,a=Array(r>1?r-1:0),i=1;i<r;i++)a[i-1]=arguments[i];return s.produceWithPatches(t,t=>e(t,...a))}}return[this.produce(e,t,(e,t)=>{r=e,a=t}),r,a]},"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze),"boolean"==typeof(null==e?void 0:e.useStrictShallowCopy)&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}}().produce,W=e.i(35889),V=e.i(56124),H=e.i(76220),X=e.i(12041),q=e.i(77148),G=e.i(64925),J=e.i(73665),Q=e.i(71508),Y=e.i(70319);function Z(e){return(e=e.replace(/\s+/g," ").trim())?e.split(/(\s+|[.,!?;:\-â€”()"'â€œâ€â€žÂ«Â»â€¦])/).filter(e=>null!=e&&""!==e).filter(e=>e.trim().length>0||" "===e):[]}function $(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}let ee=(e,t)=>{let a=Z(e),s=Z(t),{matchesB:i}=function(e,t){let r=e.length,a=t.length,s=Array.from({length:r+1},()=>Array(a+1).fill(0));for(let i=r-1;i>=0;i--)for(let r=a-1;r>=0;r--)e[i]===t[r]?s[i][r]=1+s[i+1][r+1]:s[i][r]=Math.max(s[i+1][r],s[i][r+1]);let i=0,n=0,o=[];for(;i<r&&n<a;)e[i]===t[n]?(o.push(n),i++,n++):s[i+1][n]>=s[i][n+1]?i++:n++;return{matchesB:o}}(a,s),n=new Set(i);return s.map((e,t)=>n.has(t)?(0,r.jsx)("span",{children:$(e)},t):(0,r.jsx)("span",{style:{background:"#ffeb3b"},children:$(e)},t))};var et=e.i(95187),er=(0,et.createServerReference)("608a246e649e5dc67df063da3a67287b3af4d7797a",et.callServer,void 0,et.findSourceMapURL,"removeAudio"),ea=(0,et.createServerReference)("40237a02ac2cddf77e02683502ed115d7eabd745fe",et.callServer,void 0,et.findSourceMapURL,"removeSentence"),es=e.i(83442);let ei="blobs";function en(){return new Promise((e,t)=>{let r=indexedDB.open("audio-store",1);r.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(ei)||t.createObjectStore(ei,{keyPath:"id"})},r.onsuccess=()=>{e(r.result)},r.onerror=()=>{t(r.error)}})}async function eo(e,t){let r=await en();return new Promise((a,s)=>{let i=r.transaction(ei,"readwrite").objectStore(ei),n={uuid:e,audioBlob:t,createdAt:Date.now()},o=i.put(n);o.onsuccess=()=>a(),o.onerror=()=>s(o.error)})}async function el(e){let t=await en();return new Promise((r,a)=>{let s=t.transaction(ei,"readonly").objectStore(ei).get(e);s.onsuccess=()=>{let e=s.result;r(e?e.audioBlob:null)},s.onerror=()=>a(s.error)})}async function ec(e){let t=await en();return new Promise((r,a)=>{let s=t.transaction(ei,"readwrite").objectStore(ei).delete(e);s.onsuccess=()=>r(),s.onerror=()=>a(s.error)})}let ed=new Map,eu=new FinalizationRegistry(e=>{ed.delete(e)});function ef(e,t){if("undefined"==typeof WeakRef)return;let r=new WeakRef(t);ed.set(e,r);try{eu.register(t,e,t)}catch(e){console.log(e)}}function ep(e){let t=ed.get(e);if(!t)return null;let r=t.deref();return r||(ed.delete(e),null)}function em(e){ed.delete(e)}function eh(e){let{item:t,engine:s,onUpdate:i,onDelete:n}=e,[o,l]=(0,a.useState)(!1),[c,d]=(0,a.useState)(!1),[u,f]=(0,a.useState)(!1),[p,m]=(0,a.useState)(!1),h=(0,a.useRef)([]),_=(0,a.useRef)(null),v=async()=>{let e=async(e,r)=>{"success"===e.status?(await eo(t.uuid,r),ef(t.uuid,r),i({...t,recognized:e.data,modified_db:!0,modified_fs:!0})):Y.toast.error(e.error)};t.modified_fs&&(await ec(t.uuid),em(t.uuid)),await (0,Q.toggleRecording)(o,l,h,_,!0,s,d,e=>{console.log(e)},e)},y=async()=>{if(t.modified_fs&&(await ec(t.uuid),em(t.uuid)),t.on_fs){if("success"!==(await er("reading","".concat(t.uuid,".wav"))).status)return void Y.toast.error("delete audio failed");Y.toast.success("delete audio success")}if(t.in_db){if("success"!==(await ea(t.uuid)).status)return void Y.toast.error("delete sentence failed");Y.toast.success("delete sentence success")}n(t.uuid)};return(0,r.jsxs)("div",{className:"flex flex-col items-start justify-start w-full rounded-lg bg-sand-300",children:[(0,r.jsxs)("div",{className:"flex flex-row items-start justify-start w-full my-2",children:[t.modified_db||t.modified_fs?(0,r.jsx)(G.Tooltip,{placement:"bottom",content:"unsaved",children:(0,r.jsx)("div",{className:"text-red-500",children:"â—"})}):(0,r.jsx)("div",{className:"text-transparent",children:"â—"}),(0,r.jsxs)("div",{className:"flex flex-col w-full ps-2",children:[(0,r.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,r.jsxs)("div",{className:"flex flex-row items-center justify-start w-full",children:[(0,r.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,r.jsx)(G.Tooltip,{placement:"top",content:"re-record",children:(0,r.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:!o&&c,onPress:v,children:o?(0,r.jsx)(J.MdMic,{size:20}):(0,r.jsx)(J.MdMicOff,{size:20})})}),(0,r.jsx)(G.Tooltip,{placement:"top",content:"play audio",children:(0,r.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{if(t.modified_fs){let e=ep(t.uuid);if(e||((e=await el(t.uuid))?ef(t.uuid,e):Y.toast.error("Blob of audio not found")),e){let t=URL.createObjectURL(e),r=new Audio(t);r.play(),r.onended=()=>{URL.revokeObjectURL(t)}}}else new Audio(t.audio_path).play()},children:(0,r.jsx)(J.MdPlayCircle,{size:20})})})]}),(0,r.jsxs)("div",{className:"flex flex-row items-center justify-end",children:[(0,r.jsx)(G.Tooltip,{placement:"top",content:"show/hide original",children:(0,r.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>m(!p),children:p?(0,r.jsx)(J.MdOutlineKeyboardDoubleArrowUp,{size:20}):(0,r.jsx)(J.MdOutlineKeyboardDoubleArrowDown,{size:20})})}),(0,r.jsx)(G.Tooltip,{placement:"top",content:"delete",children:(0,r.jsx)(W.Button,{isIconOnly:!0,variant:"light",color:"danger",className:"w-fit h-fit",onPress:()=>{window.confirm("Are you sure to delete?")&&y()},children:(0,r.jsx)(J.MdDelete,{size:20})})})]})]}),(0,r.jsx)("div",{className:"text-xl text-balance hyphens-auto",children:ee(t.original,t.recognized)})]}),(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center w-fit gap-1",children:[(0,r.jsx)(G.Tooltip,{placement:"left",content:"move upward",children:(0,r.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{i({...t,order_num:t.order_num+1,modified_db:!0})},children:(0,r.jsx)(J.MdArrowUpward,{size:20})})}),(0,r.jsx)("div",{children:t.order_num}),(0,r.jsx)(G.Tooltip,{placement:"left",content:"move downward",children:(0,r.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{i({...t,order_num:t.order_num-1,modified_db:!0})},children:(0,r.jsx)(J.MdArrowDownward,{size:20})})})]})]}),p&&(0,r.jsx)("div",{className:"flex flex-row items-center justify-start w-full px-2 pb-1",children:(0,r.jsx)(q.Textarea,{size:"lg",className:"w-full",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:t.original,onChange:e=>{i({...t,original:e.target.value,modified_db:!0})},endContent:(0,r.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:u,onPress:async()=>{let e="/api/data/tts/".concat(t.uuid,".wav");if(!await fetch(e,{method:"HEAD"}).then(e=>e.ok).catch(()=>!1)){f(!0);let e=await (0,es.callTTS)(t.uuid,t.original);if(f(!1),"error"===e.status)return void console.error(e.error)}new Audio(e).play().catch(e=>console.error("error: ",e))},children:(0,r.jsx)(J.MdPlayCircle,{size:20})})})})]})}var e_=e.i(75157),ev=(0,et.createServerReference)("4099bd47f4146d31376754ff6dfbde43a2e4c5824a",et.callServer,void 0,et.findSourceMapURL,"getBookAll"),ey=e.i(2243),eg=e.i(50453),ex=e.i(5483),eb=e.i(212);function ew(e){let{user_id:t,onSelect:s}=e,[i,n]=(0,a.useState)([]),[o,l]=(0,a.useState)(""),[c,d]=(0,a.useState)(!1),[u,f]=(0,a.useState)(!1),[p,m]=(0,a.useState)(!1),h=async()=>{m(!0);let e=await ev(t);"success"===e.status&&n(e.data),m(!1)},_=async()=>{if(!t)return void Y.toast.error("not logged in");f(!0),"success"===(await (0,eg.saveBook)({uuid:(0,e_.getUUID)(),user_id:t,name:o,created_by:t,created_at:new Date,updated_at:new Date})).status?(Y.toast.success("save book success"),l("")):Y.toast.error("save book failed"),f(!1)},v=async e=>{f(!0),"success"===(await (0,ey.removeBook)(e)).status?Y.toast.success("delete book success"):Y.toast.error("delete book failed"),f(!1)};return(0,a.useEffect)(()=>{h()},[t]),(0,r.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,r.jsx)(V.Select,{label:"Select book",onChange:async e=>{let t=e.target.value;await s(t)},endContent:p&&(0,r.jsx)(ex.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:i.map(e=>(0,r.jsx)(H.SelectItem,{textValue:e.name,children:e.name},e.uuid))}),(0,r.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,r.jsx)(W.Button,{size:"sm",radius:"full",onPress:()=>d(!c),children:c?"finish":"edit"}),(0,r.jsx)(W.Button,{size:"sm",radius:"full",onPress:h,children:"refresh"})]}),c&&(0,r.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,r.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,r.jsx)(eb.Input,{label:"Name of Book",size:"sm",onChange:e=>l(e.target.value)}),(0,r.jsx)(W.Button,{size:"sm",radius:"full",isDisabled:u,onPress:_,children:"add"})]}),i.map(e=>(0,r.jsxs)("div",{className:"flex flex-row items-center justify-start px-2 gap-2 bg-sand-300",children:[e.name,(0,r.jsx)(W.Button,{size:"sm",radius:"full",onPress:()=>v(e.uuid),children:"delete"})]},e.uuid))]})]})}var ej=(0,et.createServerReference)("4062cac3c155dc6f0109466203ffe5a86fb57535e3",et.callServer,void 0,et.findSourceMapURL,"getSentenceAll"),eS=(0,et.createServerReference)("409068985e3c0497defe9309aeb7f6a5eb73ac7f81",et.callServer,void 0,et.findSourceMapURL,"saveSentence"),eP=(0,et.createServerReference)("40dc1f9d233fc2ae8c918dceb3011d916c7224ec9f",et.callServer,void 0,et.findSourceMapURL,"getChapterAll"),ez=(0,et.createServerReference)("403e6948e4ba5f359892755f5c4fc086313e01538f",et.callServer,void 0,et.findSourceMapURL,"removeChapter"),eN=(0,et.createServerReference)("40a2c410a5d5d7df29b52950512ffb7a79a89b1dce",et.callServer,void 0,et.findSourceMapURL,"saveChapter");function eR(e){let{user_id:t,book_uuid:s,onSelect:i}=e,[n,o]=(0,a.useState)([]),[l,c]=(0,a.useState)(""),[d,u]=(0,a.useState)(""),[f,p]=(0,a.useState)(!1),[m,h]=(0,a.useState)(!1),[_,v]=(0,a.useState)(!1),y=async()=>{v(!0);let e=await eP(s);"success"===e.status&&o(e.data),v(!1)},g=async()=>t?s?void(h(!0),"success"===(await eN({uuid:(0,e_.getUUID)(),book_uuid:s,order_num:parseInt(l,10),name:d,created_by:t,created_at:new Date,updated_at:new Date})).status?(Y.toast.success("save chapter success"),u("")):Y.toast.error("save chapter failed"),h(!1)):void Y.toast.error("no book selected"):void Y.toast.error("not logged in"),x=async e=>{h(!0),"success"===(await ez(e)).status?Y.toast.success("delete chapter success"):Y.toast.error("delete chapter failed"),h(!1)};return(0,a.useEffect)(()=>{y()},[s]),(0,r.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,r.jsx)(V.Select,{label:"Select chapter",onChange:async e=>{let t=e.target.value;await i(t)},endContent:_&&(0,r.jsx)(ex.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:n.map(e=>(0,r.jsxs)(H.SelectItem,{textValue:"".concat(e.order_num,", ").concat(e.name),children:[e.order_num,", ",e.name]},e.uuid))}),(0,r.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,r.jsx)(W.Button,{size:"sm",radius:"full",onPress:()=>p(!f),children:f?"finish":"edit"}),(0,r.jsx)(W.Button,{size:"sm",radius:"full",onPress:y,children:"refresh"})]}),f&&(0,r.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,r.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,r.jsx)(eb.Input,{label:"Order",type:"number",size:"sm",className:"w-1/5",onChange:e=>c(e.target.value)}),(0,r.jsx)(eb.Input,{label:"Name of Book",size:"sm",onChange:e=>u(e.target.value)}),(0,r.jsx)(W.Button,{size:"sm",radius:"full",isDisabled:m,onPress:g,children:"add"})]}),n.map(e=>(0,r.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2 bg-sand-300",children:[e.order_num," - ",e.name,(0,r.jsx)(W.Button,{size:"sm",radius:"full",onPress:()=>x(e.uuid),children:"delete"})]},e.uuid))]})]})}var eO=(0,et.createServerReference)("706689d7ff3af380b2a007738565944a90fc0353d0",et.callServer,void 0,et.findSourceMapURL,"saveAudio");function eA(e){var t,s,i;let{email:n}=e,[o,l]=(0,a.useState)(""),[c,d]=(0,a.useState)(""),[u,f]=(0,a.useState)("local"),[p,m]=(0,a.useState)(!1),[h,_]=(0,a.useState)(!1),[v,y]=(0,a.useState)(),[g,x]=(t=[],i=(s=(0,a.useState)(function(){return b("function"==typeof t?t():t,!0)}))[1],[s[0],(0,a.useCallback)(function(e){i("function"==typeof e?K(e):b(e))},[])]),[w,j]=(0,a.useState)(!1),[S,P]=(0,a.useState)(!1),[z,N]=(0,a.useState)(!1),R=(0,a.useRef)([]),O=(0,a.useRef)(null),A=(0,a.useMemo)(()=>g.slice().reverse(),[g]),D=async e=>{P(!0);let t=await ej(e);if("success"===t.status){let e=t.data.map((e,t)=>(e.order_num!==t+1&&j(!0),{...(0,e_.toExactType)(e),order_num:t+1,in_db:!0,on_fs:!0,modified_db:e.order_num!==t+1,modified_fs:!1}));x(t=>{for(let r of(t.length=0,e))t.push(r)})}P(!1)},B=e=>{x(t=>{let r=t.findIndex(t=>t.uuid===e.uuid);if(-1!==r){if(t[r].order_num!==e.order_num){t.splice(r,1);let a=Math.max(0,Math.min(t.length,e.order_num-1));t.splice(a,0,{...e})}else t[r]={...e};t.forEach((e,t)=>{e.modified_db||e.order_num===t+1||(e.modified_db=e.order_num!==t+1),e.order_num=t+1})}}),j(!0)},k=e=>{x(t=>{let r=t.findIndex(t=>t.uuid===e);-1!==r&&t.splice(r,1),t.forEach((e,t)=>{e.modified_db||e.order_num===t+1||(e.modified_db=e.order_num!==t+1),e.order_num=t+1,e.order_num=t+1})}),j(!0)},C=async()=>{if(!v)return;N(!0);let e=ep(v.uuid);if(e||(e=await el(v.uuid)),!e){Y.toast.error("Blob of audio not found"),N(!1);return}if("success"===(await eO(e,"reading","".concat(v.uuid,".wav"))).status)await ec(v.uuid),em(v.uuid);else{Y.toast.error("save audio failed"),N(!1);return}if("error"===(await eS({uuid:v.uuid,chapter_uuid:v.chapter_uuid,order_num:v.order_num,original:v.original,recognized:v.recognized,audio_path:"/api/data/reading/".concat(v.uuid,".wav"),created_by:n,created_at:v.created_at||new Date,updated_at:new Date})).status){Y.toast.error("save db failed"),N(!1);return}x(e=>{e.push({...v,in_db:!0,on_fs:!0,modified_db:!1,modified_fs:!1})}),y(void 0),Y.toast.success("added and saved successfully!"),N(!1)},M=async()=>{N(!0);try{for(let e of g){if(e.modified_fs){let t=ep(e.uuid);if(t||(t=await el(e.uuid)),!t)throw Error("".concat(e.order_num,": Blob of audio not found"));let r=await eO(t,"reading","".concat(e.uuid,".wav"));if("success"===r.status)await ec(e.uuid),em(e.uuid),x(t=>{let r=t.find(t=>t.uuid===e.uuid);r&&(r.on_fs=!0,r.modified_fs=!1)});else throw Error("".concat(e.order_num,": save audio failed"))}let t=await eS({uuid:e.uuid,chapter_uuid:e.chapter_uuid,order_num:e.order_num,original:e.original,recognized:e.recognized,audio_path:e.audio_path,created_by:n,created_at:e.created_at||new Date,updated_at:new Date});if("error"===t.status)throw Error("save sentence failed");x(t=>{let r=t.find(t=>t.uuid===e.uuid);r&&(r.in_db=!0,r.modified_db=!1)})}j(!1),Y.toast.success("All sentences saved successfully!")}catch(e){Y.toast.error(e.message||"Failed to save sentences")}N(!1)};return(0,a.useEffect)(()=>{let e=e=>{if(e.ctrlKey&&"a"===e.key){e.preventDefault();let t=document.getElementById("button-toggel-recording");null==t||t.click()}if(e.ctrlKey&&"s"===e.key){e.preventDefault();let t=document.getElementById("button-add-save");null==t||t.click()}};return document.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[p,h]),(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex flex-col md:flex-row gap-4 my-4",children:[(0,r.jsx)(ew,{user_id:n,onSelect:async e=>{l(e)}}),(0,r.jsx)(eR,{user_id:n,book_uuid:o,onSelect:async e=>{d(e),y(void 0),j(!1),await D(e)}})]}),(0,r.jsxs)("div",{className:"flex flex-row items-center justify-center gap-4 my-4",children:[(0,r.jsx)(V.Select,{className:"max-w-sm",selectedKeys:[u],onChange:e=>f(e.target.value),startContent:(0,r.jsx)("div",{className:"whitespace-nowrap font-bold",children:"AI Engine"}),children:Q.EngineList.map(e=>(0,r.jsx)(H.SelectItem,{textValue:e.value,children:e.value},e.key))}),(0,r.jsx)(W.Button,{variant:"solid",color:"primary",id:"button-toggel-recording",isDisabled:!p&&h,onPress:()=>{if(o&&c){v&&y(void 0);let e=async(e,t)=>{if("success"===e.status){let r=(0,e_.getUUID)();await eo(r,t),ef(r,t),y({uuid:r,chapter_uuid:c,order_num:g.length+1,original:e.data,recognized:e.data,audio_path:"/api/data/reading/".concat(r,".wav"),in_db:!1,on_fs:!1,modified_db:!0,modified_fs:!0})}else Y.toast.error(e.error)};(0,Q.toggleRecording)(p,m,R,O,!0,u,_,e=>{console.log(e)},e)}else alert("select book and chapter first")},children:p?"â¹ Stop Recording (Ctrl+A)":h?"Processing":"ðŸŽ¤ Read a Sentence (Ctrl+A)"})]}),v&&(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center w-full gap-2 my-4",children:[(0,r.jsxs)("div",{className:"flex flex-col w-full p-2 rounded-lg bg-sand-300",children:[(0,r.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,r.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,r.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{let e=ep(v.uuid);if(e||((e=await el(v.uuid))?ef(v.uuid,e):Y.toast.error("Blob of audio not found")),e){let t=URL.createObjectURL(e),r=new Audio(t);r.play(),r.onended=()=>{URL.revokeObjectURL(t)}}},children:(0,r.jsx)(J.MdPlayCircle,{size:20})})]}),(0,r.jsx)("div",{className:"text-xl",children:ee(v.original,v.recognized)}),(0,r.jsx)(q.Textarea,{size:"lg",className:"w-full",label:"original text",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:v.original,onChange:e=>y({...v,original:e.target.value})})]}),(0,r.jsx)(W.Button,{variant:"solid",color:"primary",id:"button-add-save",isDisabled:z,onPress:C,children:"Add & Save (Ctrl+S)"})]}),S&&(0,r.jsx)("div",{className:"flex flex-row w-full items-center justify-center gap-4 my-4",children:(0,r.jsx)(X.Spinner,{classNames:{label:"text-foreground mt-4"},variant:"simple"})}),w&&(0,r.jsx)("div",{className:"flex flex-row items-center justify-end my-4 mb-0",children:(0,r.jsx)(W.Button,{variant:"solid",color:"primary",isDisabled:z,onPress:M,children:"Save"})}),g.length>0&&(0,r.jsx)("div",{className:"flex flex-col w-full gap-4 my-4",children:A.map((e,t)=>(0,r.jsx)(eh,{item:e,engine:u,onUpdate:B,onDelete:k},"".concat(t,"-").concat(e.uuid)))})]})}}]);