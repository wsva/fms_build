(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,22980,e=>{"use strict";e.s(["default",()=>ey],22980);var t,a=e.i(43476),r=e.i(71645);e.i(47167);var s=Symbol.for("immer-nothing"),i=Symbol.for("immer-draftable"),n=Symbol.for("immer-state");function l(e){for(var t=arguments.length,a=Array(t>1?t-1:0),r=1;r<t;r++)a[r-1]=arguments[r];throw Error("[Immer] minified error nr: ".concat(e,". Full error at: https://bit.ly/3cXEKWf"))}var o=Object.getPrototypeOf;function c(e){return!!e&&!!e[n]}function d(e){var t;return!!e&&(f(e)||Array.isArray(e)||!!e[i]||!!(null==(t=e.constructor)?void 0:t[i])||v(e)||x(e))}var u=Object.prototype.constructor.toString();function f(e){if(!e||"object"!=typeof e)return!1;let t=o(e);if(null===t)return!0;let a=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return a===Object||"function"==typeof a&&Function.toString.call(a)===u}function p(e,t){0===h(e)?Reflect.ownKeys(e).forEach(a=>{t(a,e[a],e)}):e.forEach((a,r)=>t(r,a,e))}function h(e){let t=e[n];return t?t.type_:Array.isArray(e)?1:v(e)?2:3*!!x(e)}function m(e,t){return 2===h(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function _(e,t,a){let r=h(e);2===r?e.set(t,a):3===r?e.add(a):e[t]=a}function v(e){return e instanceof Map}function x(e){return e instanceof Set}function g(e){return e.copy_||e.base_}function y(e,t){if(v(e))return new Map(e);if(x(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);let a=f(e);if(!0!==t&&("class_only"!==t||a)){let t=o(e);return null!==t&&a?{...e}:Object.assign(Object.create(t),e)}{let t=Object.getOwnPropertyDescriptors(e);delete t[n];let a=Reflect.ownKeys(t);for(let r=0;r<a.length;r++){let s=a[r],i=t[s];!1===i.writable&&(i.writable=!0,i.configurable=!0),(i.get||i.set)&&(t[s]={configurable:!0,writable:!0,enumerable:i.enumerable,value:e[s]})}return Object.create(o(e),t)}}function b(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return w(e)||c(e)||!d(e)||(h(e)>1&&Object.defineProperties(e,{set:{value:j},add:{value:j},clear:{value:j},delete:{value:j}}),Object.freeze(e),t&&Object.values(e).forEach(e=>b(e,!0))),e}function j(){l(2)}function w(e){return Object.isFrozen(e)}var S={};function z(e){let t=S[e];return t||l(0,e),t}function P(e,t){t&&(z("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function N(e){B(e),e.drafts_.forEach(R),e.drafts_=null}function B(e){e===t&&(t=e.parent_)}function O(e){return t={drafts_:[],parent_:t,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function R(e){let t=e[n];0===t.type_||1===t.type_?t.revoke_():t.revoked_=!0}function A(e,t){t.unfinalizedDrafts_=t.drafts_.length;let a=t.drafts_[0];return void 0!==e&&e!==a?(a[n].modified_&&(N(t),l(4)),d(e)&&(e=D(t,e),t.parent_||C(t,e)),t.patches_&&z("Patches").generateReplacementPatches_(a[n].base_,e,t.patches_,t.inversePatches_)):e=D(t,a,[]),N(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==s?e:void 0}function D(e,t,a){if(w(t))return t;let r=t[n];if(!r)return p(t,(s,i)=>M(e,r,t,s,i,a)),t;if(r.scope_!==e)return t;if(!r.modified_)return C(e,r.base_,!0),r.base_;if(!r.finalized_){r.finalized_=!0,r.scope_.unfinalizedDrafts_--;let t=r.copy_,s=t,i=!1;3===r.type_&&(s=new Set(t),t.clear(),i=!0),p(s,(s,n)=>M(e,r,t,s,n,a,i)),C(e,t,!1),a&&e.patches_&&z("Patches").generatePatches_(r,a,e.patches_,e.inversePatches_)}return r.copy_}function M(e,t,a,r,s,i,n){if(c(s)){let n=D(e,s,i&&t&&3!==t.type_&&!m(t.assigned_,r)?i.concat(r):void 0);if(_(a,r,n),!c(n))return;e.canAutoFreeze_=!1}else n&&a.add(s);if(d(s)&&!w(s)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;D(e,s),(!t||!t.scope_.parent_)&&"symbol"!=typeof r&&(v(a)?a.has(r):Object.prototype.propertyIsEnumerable.call(a,r))&&C(e,s)}}function C(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&b(t,a)}var k={get(e,t){if(t===n)return e;let a=g(e);if(!m(a,t)){var r,s=e,i=a,l=t;let n=E(i,l);return n?"value"in n?n.value:null==(r=n.get)?void 0:r.call(s.draft_):void 0}let o=a[t];return e.finalized_||!d(o)?o:o===I(e.base_,t)?(T(e),e.copy_[t]=F(o,e)):o},has:(e,t)=>t in g(e),ownKeys:e=>Reflect.ownKeys(g(e)),set(e,t,a){let r=E(g(e),t);if(null==r?void 0:r.set)return r.set.call(e.draft_,a),!0;if(!e.modified_){let r=I(g(e),t),s=null==r?void 0:r[n];if(s&&s.base_===a)return e.copy_[t]=a,e.assigned_[t]=!1,!0;if((a===r?0!==a||1/a==1/r:a!=a&&r!=r)&&(void 0!==a||m(e.base_,t)))return!0;T(e),L(e)}return!!(e.copy_[t]===a&&(void 0!==a||t in e.copy_)||Number.isNaN(a)&&Number.isNaN(e.copy_[t]))||(e.copy_[t]=a,e.assigned_[t]=!0,!0)},deleteProperty:(e,t)=>(void 0!==I(e.base_,t)||t in e.base_?(e.assigned_[t]=!1,T(e),L(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0),getOwnPropertyDescriptor(e,t){let a=g(e),r=Reflect.getOwnPropertyDescriptor(a,t);return r?{writable:!0,configurable:1!==e.type_||"length"!==t,enumerable:r.enumerable,value:a[t]}:r},defineProperty(){l(11)},getPrototypeOf:e=>o(e.base_),setPrototypeOf(){l(12)}},U={};function I(e,t){let a=e[n];return(a?g(a):e)[t]}function E(e,t){if(!(t in e))return;let a=o(e);for(;a;){let e=Object.getOwnPropertyDescriptor(a,t);if(e)return e;a=o(a)}}function L(e){!e.modified_&&(e.modified_=!0,e.parent_&&L(e.parent_))}function T(e){e.copy_||(e.copy_=y(e.base_,e.scope_.immer_.useStrictShallowCopy_))}function F(e,a){let r=v(e)?z("MapSet").proxyMap_(e,a):x(e)?z("MapSet").proxySet_(e,a):function(e,a){let r=Array.isArray(e),s={type_:+!!r,scope_:a?a.scope_:t,modified_:!1,finalized_:!1,assigned_:{},parent_:a,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1},i=s,n=k;r&&(i=[s],n=U);let{revoke:l,proxy:o}=Proxy.revocable(i,n);return s.draft_=o,s.revoke_=l,o}(e,a);return(a?a.scope_:t).drafts_.push(r),r}p(k,(e,t)=>{U[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),U.deleteProperty=function(e,t){return U.set.call(this,e,t,void 0)},U.set=function(e,t,a){return k.set.call(this,e[0],t,a,e[0])};var K=new class{createDraft(e){var t;d(e)||l(8),c(e)&&(c(t=e)||l(10,t),e=function e(t){let a;if(!d(t)||w(t))return t;let r=t[n];if(r){if(!r.modified_)return r.base_;r.finalized_=!0,a=y(t,r.scope_.immer_.useStrictShallowCopy_)}else a=y(t,!0);return p(a,(t,r)=>{_(a,t,e(r))}),r&&(r.finalized_=!1),a}(t));let a=O(this),r=F(e,void 0);return r[n].isManual_=!0,B(a),r}finishDraft(e,t){let a=e&&e[n];a&&a.isManual_||l(9);let{scope_:r}=a;return P(r,t),A(void 0,r)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,t){let a;for(a=t.length-1;a>=0;a--){let r=t[a];if(0===r.path.length&&"replace"===r.op){e=r.value;break}}a>-1&&(t=t.slice(a+1));let r=z("Patches").applyPatches_;return c(e)?r(e,t):this.produce(e,e=>r(e,t))}constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,t,a)=>{let r;if("function"==typeof e&&"function"!=typeof t){let a=t;t=e;let r=this;return function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a;for(var s=arguments.length,i=Array(s>1?s-1:0),n=1;n<s;n++)i[n-1]=arguments[n];return r.produce(e,e=>t.call(this,e,...i))}}if("function"!=typeof t&&l(6),void 0!==a&&"function"!=typeof a&&l(7),d(e)){let s=O(this),i=F(e,void 0),n=!0;try{r=t(i),n=!1}finally{n?N(s):B(s)}return P(s,a),A(r,s)}if(e&&"object"==typeof e)l(1,e);else{if(void 0===(r=t(e))&&(r=e),r===s&&(r=void 0),this.autoFreeze_&&b(r,!0),a){let t=[],s=[];z("Patches").generateReplacementPatches_(e,r,t,s),a(t,s)}return r}},this.produceWithPatches=(e,t)=>{let a,r;if("function"==typeof e){var s=this;return function(t){for(var a=arguments.length,r=Array(a>1?a-1:0),i=1;i<a;i++)r[i-1]=arguments[i];return s.produceWithPatches(t,t=>e(t,...r))}}return[this.produce(e,t,(e,t)=>{a=e,r=t}),a,r]},"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze),"boolean"==typeof(null==e?void 0:e.useStrictShallowCopy)&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}}().produce,W=e.i(35889),V=e.i(12041),H=e.i(77148),X=e.i(64925),q=e.i(73665),G=e.i(71508),J=e.i(70319);function Q(e){return(e=e.replace(/\s+/g," ").trim())?e.split(/(\s+|[.,!?;:\-â€”()"'â€œâ€â€žÂ«Â»â€¦])/).filter(e=>null!=e&&""!==e).filter(e=>e.trim().length>0||" "===e):[]}function Y(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}let Z=(e,t)=>{let r=Q(e),s=Q(t),{matchesB:i}=function(e,t){let a=e.length,r=t.length,s=Array.from({length:a+1},()=>Array(r+1).fill(0));for(let i=a-1;i>=0;i--)for(let a=r-1;a>=0;a--)e[i]===t[a]?s[i][a]=1+s[i+1][a+1]:s[i][a]=Math.max(s[i+1][a],s[i][a+1]);let i=0,n=0,l=[];for(;i<a&&n<r;)e[i]===t[n]?(l.push(n),i++,n++):s[i+1][n]>=s[i][n+1]?i++:n++;return{matchesB:l}}(r,s),n=new Set(i);return s.map((e,t)=>n.has(t)?(0,a.jsx)("span",{children:Y(e)},t):(0,a.jsx)("span",{style:{background:"#ffeb3b"},children:Y(e)},t))};var $=e.i(95187),ee=(0,$.createServerReference)("6016331f18b5c90584c5ac56f03b7f32d10131983d",$.callServer,void 0,$.findSourceMapURL,"removeAudio"),et=(0,$.createServerReference)("70f2ec3217808cf94d5140c08409899d70090ac619",$.callServer,void 0,$.findSourceMapURL,"saveAudio"),ea=(0,$.createServerReference)("40d8d6caaae413bebf44f37135f0ae6f7b91f7611d",$.callServer,void 0,$.findSourceMapURL,"removeSentence"),er=(0,$.createServerReference)("408c1752bef0f86127db61b1f71a75ada4cf09bdcb",$.callServer,void 0,$.findSourceMapURL,"saveSentence"),es=(0,$.createServerReference)("600784575356a8694620d2f8b86fba11df9607abdd",$.callServer,void 0,$.findSourceMapURL,"callTTS");function ei(e){let{user_id:t,item:s,onUpdate:i,onDelete:n}=e,[l,o]=(0,r.useState)(!1),[c,d]=(0,r.useState)(!1),[u,f]=(0,r.useState)(!1),[p,h]=(0,r.useState)(!1),m=(0,r.useRef)([]),_=(0,r.useRef)(null),v=async()=>{s.modified_fs&&s.audioBlob&&("success"===(await et(s.audioBlob,"reading","".concat(s.uuid,".wav"))).status?(J.toast.success("save audio success"),i({...s,on_fs:!0,modified_fs:!1})):J.toast.error("save audio failed")),s.modified_db&&("success"===(await er({uuid:s.uuid,chapter_uuid:s.chapter_uuid,order_num:s.order_num,original:s.original,recognized:s.recognized,audio_path:"/api/data/reading/".concat(s.uuid,".wav"),created_by:t,created_at:s.created_at||new Date,updated_at:new Date})).status?(J.toast.success("save sentence success"),i({...s,in_db:!0,modified_db:!1})):J.toast.error("save sentence failed"))},x=async()=>{if(s.on_fs){if("success"!==(await ee("reading","".concat(s.uuid,".wav"))).status)return void J.toast.error("delete audio failed");J.toast.success("delete audio success")}if(s.in_db){if("success"!==(await ea(s.uuid)).status)return void J.toast.error("delete sentence failed");J.toast.success("delete sentence success")}n(s.uuid)};return(0,a.jsxs)("div",{className:"flex flex-row items-start justify-start w-full bg-sand-300",children:[s.modified_db||s.modified_fs?(0,a.jsx)(X.Tooltip,{placement:"bottom",content:"unsaved",children:(0,a.jsx)("div",{className:"text-red-500",children:"â—"})}):(0,a.jsx)("div",{className:"text-transparent",children:"â—"}),(0,a.jsxs)("div",{className:"flex flex-col w-full p-2",children:[(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,a.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,a.jsx)(X.Tooltip,{placement:"top",content:"re-record",children:(0,a.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:!l&&c,onPress:()=>{(0,G.toggleRecording)(l,o,m,_,!0,d,e=>{console.log(e)},(e,t)=>{"success"===e.status?i({...s,recognized:e.data,audioBlob:t,modified_db:!0,modified_fs:!0}):J.toast.error(e.error)})},children:l?(0,a.jsx)(q.MdMic,{size:20}):(0,a.jsx)(q.MdMicOff,{size:20})})}),(0,a.jsx)(X.Tooltip,{placement:"top",content:"play audio",children:(0,a.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{new Audio(s.audioBlob?URL.createObjectURL(s.audioBlob):s.audio_path).play()},children:(0,a.jsx)(q.MdPlayCircle,{size:20})})})]}),(0,a.jsx)("div",{className:"text-xl",children:Z(s.original,s.recognized)})]}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsxs)("div",{className:"flex flex-row items-center justify-start gap-4",children:[(0,a.jsx)("div",{className:"text-md text-gray-400",children:"original text:"}),(0,a.jsx)(X.Tooltip,{placement:"top",content:"edit original",children:(0,a.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>f(!u),children:u?(0,a.jsx)(q.MdEditOff,{size:20}):(0,a.jsx)(q.MdEdit,{size:20})})}),(0,a.jsx)(X.Tooltip,{placement:"top",content:"play audio",children:(0,a.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:p,onPress:async()=>{let e="/api/data/tts/".concat(s.uuid,".wav");if(!await fetch(e,{method:"HEAD"}).then(e=>e.ok).catch(()=>!1)){h(!0);let e=await es(s.uuid,s.original);if(h(!1),"error"===e.status)return void console.error(e.error)}new Audio(e).play().catch(e=>console.error("error: ",e))},children:(0,a.jsx)(q.MdPlayCircle,{size:20})})})]}),u?(0,a.jsx)(H.Textarea,{size:"lg",className:"w-full",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:s.original,onChange:e=>{i({...s,original:e.target.value,modified_db:!0})}}):(0,a.jsx)("div",{className:"text-xl",children:s.original})]})]}),(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center w-fit gap-1 py-2",children:[(0,a.jsx)(X.Tooltip,{placement:"left",content:"move upward",children:(0,a.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>i(s,s.order_num+1),children:(0,a.jsx)(q.MdArrowUpward,{size:20})})}),(0,a.jsx)("div",{children:s.order_num}),(0,a.jsx)(X.Tooltip,{placement:"left",content:"move downward",children:(0,a.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>i(s,s.order_num-1),children:(0,a.jsx)(q.MdArrowDownward,{size:20})})}),(0,a.jsx)(X.Tooltip,{placement:"left",content:"save",children:(0,a.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:v,children:(0,a.jsx)(q.MdOutlineSave,{size:20})})}),(0,a.jsx)(X.Tooltip,{placement:"left",content:"delete",children:(0,a.jsx)(W.Button,{isIconOnly:!0,variant:"light",color:"danger",className:"h-fit",onPress:x,children:(0,a.jsx)(q.MdDelete,{size:20})})})]})]})}var en=e.i(75157),el=(0,$.createServerReference)("40c65ba96688d95387d90ebeceff58ccafb7af0fb3",$.callServer,void 0,$.findSourceMapURL,"getBookAll"),eo=e.i(99109),ec=e.i(75802),ed=e.i(5483),eu=e.i(212),ef=e.i(56124),ep=e.i(76220);function eh(e){let{user_id:t,onSelect:s}=e,[i,n]=(0,r.useState)([]),[l,o]=(0,r.useState)(""),[c,d]=(0,r.useState)(!1),[u,f]=(0,r.useState)(!1),[p,h]=(0,r.useState)(!1),m=async()=>{h(!0);let e=await el(t);"success"===e.status&&n(e.data),h(!1)},_=async()=>{if(!t)return void J.toast.error("not logged in");f(!0),"success"===(await (0,ec.saveBook)({uuid:(0,en.getUUID)(),user_id:t,name:l,created_by:t,created_at:new Date,updated_at:new Date})).status?(J.toast.success("save book success"),o("")):J.toast.error("save book failed"),f(!1)},v=async e=>{f(!0),"success"===(await (0,eo.removeBook)(e)).status?J.toast.success("delete book success"):J.toast.error("delete book failed"),f(!1)};return(0,r.useEffect)(()=>{m()},[t]),(0,a.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,a.jsx)(ef.Select,{label:"Select book",onChange:async e=>{let t=e.target.value;await s(t)},endContent:p&&(0,a.jsx)(ed.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:i.map(e=>(0,a.jsx)(ep.SelectItem,{textValue:e.name,children:e.name},e.uuid))}),(0,a.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,a.jsx)(W.Button,{size:"sm",radius:"full",onPress:()=>d(!c),children:c?"finish":"edit"}),(0,a.jsx)(W.Button,{size:"sm",radius:"full",onPress:m,children:"refresh"})]}),c&&(0,a.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,a.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,a.jsx)(eu.Input,{label:"Name of Book",size:"sm",onChange:e=>o(e.target.value)}),(0,a.jsx)(W.Button,{size:"sm",radius:"full",isDisabled:u,onPress:_,children:"add"})]}),i.map(e=>(0,a.jsxs)("div",{className:"flex flex-row items-center justify-start px-2 gap-2 bg-sand-300",children:[e.name,(0,a.jsx)(W.Button,{size:"sm",radius:"full",onPress:()=>v(e.uuid),children:"delete"})]},e.uuid))]})]})}var em=(0,$.createServerReference)("4079369c68269fa63b3a9568823bf92da4f74b95bc",$.callServer,void 0,$.findSourceMapURL,"getSentenceAll"),e_=(0,$.createServerReference)("40e7f3d16fd3aaea12aa6c4ae0f13e7519b6df0ebb",$.callServer,void 0,$.findSourceMapURL,"getChapterAll"),ev=(0,$.createServerReference)("40a924d8826948abade01de8439cafa580b599b6c3",$.callServer,void 0,$.findSourceMapURL,"removeChapter"),ex=(0,$.createServerReference)("407fc8b8b937a756fe616ac90750417a01c10a2179",$.callServer,void 0,$.findSourceMapURL,"saveChapter");function eg(e){let{user_id:t,book_uuid:s,onSelect:i}=e,[n,l]=(0,r.useState)([]),[o,c]=(0,r.useState)(""),[d,u]=(0,r.useState)(""),[f,p]=(0,r.useState)(!1),[h,m]=(0,r.useState)(!1),[_,v]=(0,r.useState)(!1),x=async()=>{v(!0);let e=await e_(s);"success"===e.status&&l(e.data),v(!1)},g=async()=>t?s?void(m(!0),"success"===(await ex({uuid:(0,en.getUUID)(),book_uuid:s,order_num:parseInt(o,10),name:d,created_by:t,created_at:new Date,updated_at:new Date})).status?(J.toast.success("save chapter success"),u("")):J.toast.error("save chapter failed"),m(!1)):void J.toast.error("no book selected"):void J.toast.error("not logged in"),y=async e=>{m(!0),"success"===(await ev(e)).status?J.toast.success("delete chapter success"):J.toast.error("delete chapter failed"),m(!1)};return(0,r.useEffect)(()=>{x()},[s]),(0,a.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,a.jsx)(ef.Select,{label:"Select chapter",onChange:async e=>{let t=e.target.value;await i(t)},endContent:_&&(0,a.jsx)(ed.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:n.map(e=>(0,a.jsxs)(ep.SelectItem,{textValue:"".concat(e.order_num,", ").concat(e.name),children:[e.order_num,", ",e.name]},e.uuid))}),(0,a.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,a.jsx)(W.Button,{size:"sm",radius:"full",onPress:()=>p(!f),children:f?"finish":"edit"}),(0,a.jsx)(W.Button,{size:"sm",radius:"full",onPress:x,children:"refresh"})]}),f&&(0,a.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,a.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,a.jsx)(eu.Input,{label:"Order",type:"number",size:"sm",className:"w-1/5",onChange:e=>c(e.target.value)}),(0,a.jsx)(eu.Input,{label:"Name of Book",size:"sm",onChange:e=>u(e.target.value)}),(0,a.jsx)(W.Button,{size:"sm",radius:"full",isDisabled:h,onPress:g,children:"add"})]}),n.map(e=>(0,a.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2 bg-sand-300",children:[e.order_num," - ",e.name,(0,a.jsx)(W.Button,{size:"sm",radius:"full",onPress:()=>y(e.uuid),children:"delete"})]},e.uuid))]})]})}function ey(e){var t,s,i;let{email:n}=e,[l,o]=(0,r.useState)(""),[c,d]=(0,r.useState)(""),[u,f]=(0,r.useState)(!1),[p,h]=(0,r.useState)(!1),[m,_]=(0,r.useState)(),[v,x]=(t=[],i=(s=(0,r.useState)(function(){return b("function"==typeof t?t():t,!0)}))[1],[s[0],(0,r.useCallback)(function(e){i("function"==typeof e?K(e):b(e))},[])]),[g,y]=(0,r.useState)(!1),[j,w]=(0,r.useState)(!1),[S,z]=(0,r.useState)(!1),P=(0,r.useRef)([]),N=(0,r.useRef)(null),B=(0,r.useMemo)(()=>v.slice().reverse(),[v]),O=async e=>{w(!0);let t=await em(e);if("success"===t.status){let e=t.data.map((e,t)=>(e.order_num!==t+1&&y(!0),{...(0,en.toExactType)(e),order_num:t+1,in_db:!0,on_fs:!0,modified_db:e.order_num!==t+1,modified_fs:!1}));x(t=>{for(let a of(t.length=0,e))t.push(a)})}w(!1)},R=(e,t)=>{x(a=>{let r=a.findIndex(t=>t.uuid===e.uuid);if(-1!==r){if(t){let e=a.splice(r,1)[0],s=Math.max(0,Math.min(a.length,t-1));a.splice(s,0,e)}else a[r]={...a[r],...e};a.forEach((e,t)=>{e.order_num=t+1,e.modified_db=e.order_num!==t+1})}}),y(!0)},A=e=>{x(t=>{let a=t.findIndex(t=>t.uuid===e);-1!==a&&t.splice(a,1),t.forEach((e,t)=>{e.order_num=t+1,e.modified_db=e.order_num!==t+1})}),y(!0)},D=async()=>{if(m){if(z(!0),m.audioBlob&&"error"===(await et(m.audioBlob,"reading","".concat(m.uuid,".wav"))).status)return void J.toast.error("save audio failed");if("error"===(await er({uuid:m.uuid,chapter_uuid:m.chapter_uuid,order_num:m.order_num,original:m.original,recognized:m.recognized,audio_path:"/api/data/reading/".concat(m.uuid,".wav"),created_by:n,created_at:m.created_at||new Date,updated_at:new Date})).status)return void J.toast.error("save db failed");x(e=>e.push(m)),_(void 0),J.toast.success("added and saved successfully!"),z(!1)}},M=async()=>{z(!0);try{for(let e of v){if(e.modified_fs&&e.audioBlob){let t=await et(e.audioBlob,"reading","".concat(e.uuid,".wav"));if("error"===t.status)throw Error("save audio failed");x(t=>{let a=t.find(t=>t.uuid===e.uuid);a&&(a.audioBlob=void 0,a.on_fs=!0,a.modified_fs=!1)})}let t=await er({uuid:e.uuid,chapter_uuid:e.chapter_uuid,order_num:e.order_num,original:e.original,recognized:e.recognized,audio_path:"/api/data/reading/".concat(e.uuid,".wav"),created_by:n,created_at:e.created_at||new Date,updated_at:new Date});if("error"===t.status)throw Error("save sentence failed");x(t=>{let a=t.find(t=>t.uuid===e.uuid);a&&(a.in_db=!0,a.modified_db=!1)})}y(!1),J.toast.success("All sentences saved successfully!")}catch(e){J.toast.error(e.message||"Failed to save sentences")}z(!1)};return(0,r.useEffect)(()=>{let e=e=>{if(e.ctrlKey&&"a"===e.key){e.preventDefault();let t=document.getElementById("button-toggel-recording");null==t||t.click()}if(e.ctrlKey&&"s"===e.key){e.preventDefault();let t=document.getElementById("button-save-all");null==t||t.click()}};return document.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[u,p]),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex flex-col md:flex-row gap-4 my-2",children:[(0,a.jsx)(eh,{user_id:n,onSelect:async e=>{o(e)}}),(0,a.jsx)(eg,{user_id:n,book_uuid:l,onSelect:async e=>{d(e),await O(e)}})]}),(0,a.jsxs)("div",{className:"flex flex-row items-center justify-center gap-4 my-8",children:[(0,a.jsx)(W.Button,{variant:"solid",color:"primary",id:"button-toggel-recording",isDisabled:!u&&p,onPress:()=>{l&&c?(0,G.toggleRecording)(u,f,P,N,!0,h,e=>{console.log(e)},(e,t)=>{"success"===e.status?_({uuid:(0,en.getUUID)(),chapter_uuid:c,order_num:v.length+1,original:e.data,recognized:e.data,audioBlob:t,in_db:!0,on_fs:!0,modified_db:!1,modified_fs:!1}):J.toast.error(e.error)}):alert("select book and chapter first")},children:u?"â¹ Stop Recording (Ctrl+A)":p?"Processing":"ðŸŽ¤ Read a Sentence (Ctrl+A)"}),m&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center gap-2",children:[(0,a.jsxs)("div",{className:"flex flex-col bg-sand-300",children:[(0,a.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,a.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,a.jsx)(W.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{new Audio(m.audioBlob?URL.createObjectURL(m.audioBlob):m.audio_path).play()},children:(0,a.jsx)(q.MdPlayCircle,{size:20})})]}),(0,a.jsx)("div",{className:"text-xl",children:Z(m.original,m.recognized)}),(0,a.jsx)("div",{className:"text-md text-gray-400",children:"original text:"}),(0,a.jsx)(H.Textarea,{size:"lg",className:"w-full",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:m.original,onChange:e=>_({...m,original:e.target.value})})]}),(0,a.jsx)(W.Button,{variant:"solid",color:"primary",id:"button-save-all",isDisabled:S,onPress:D,children:"Add & Save (Ctrl+S)"})]})]}),j&&(0,a.jsx)("div",{className:"flex flex-row w-full items-center justify-center gap-4",children:(0,a.jsx)(V.Spinner,{classNames:{label:"text-foreground mt-4"},variant:"simple"})}),g&&(0,a.jsx)("div",{className:"flex flex-row items-center justify-end my-1",children:(0,a.jsx)(W.Button,{variant:"solid",color:"primary",isDisabled:S,onPress:M,children:"Save"})}),v.length>0&&(0,a.jsx)("div",{className:"flex flex-col w-full gap-2",children:B.map(e=>(0,a.jsx)(ei,{user_id:n,item:e,onUpdate:R,onDelete:A},e.uuid))})]})}}]);