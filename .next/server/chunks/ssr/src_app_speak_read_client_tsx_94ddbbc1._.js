module.exports=[58041,a=>{"use strict";a.s(["default",()=>R],58041);var b=a.i(87924),c=a.i(72131),d=a.i(88303),e=a.i(32496),f=a.i(4655),g=a.i(24647),h=a.i(72571),i=a.i(84476),j=a.i(88206),k=a.i(328),l=a.i(84850),m=a.i(20094),n=a.i(5050),o=(0,n.createServerReference)("60c31d5544c12a193cc1797bebe6de2e7d695491c7",n.callServer,void 0,n.findSourceMapURL,"removeAudio"),p=(0,n.createServerReference)("402c16fb7a756f54aa1fb67e7ae6ef387d40f67a8d",n.callServer,void 0,n.findSourceMapURL,"removeSentence"),q=a.i(40972);let r="blobs";function s(){return new Promise((a,b)=>{let c=indexedDB.open("audio-store",1);c.onupgradeneeded=a=>{let b=a.target.result;b.objectStoreNames.contains(r)||b.createObjectStore(r,{keyPath:"uuid"})},c.onsuccess=()=>{a(c.result)},c.onerror=()=>{b(c.error)}})}async function t(a,b){let c=await s();return new Promise((d,e)=>{let f=c.transaction(r,"readwrite").objectStore(r),g={uuid:a,audioBlob:b,createdAt:Date.now()},h=f.put(g);h.onsuccess=()=>d(),h.onerror=()=>e(h.error)})}async function u(a){let b=await s();return new Promise((c,d)=>{let e=b.transaction(r,"readonly").objectStore(r).get(a);e.onsuccess=()=>{let a=e.result;c(a?a.audioBlob:null)},e.onerror=()=>d(e.error)})}async function v(a){let b=await s();return new Promise((c,d)=>{let e=b.transaction(r,"readwrite").objectStore(r).delete(a);e.onsuccess=()=>c(),e.onerror=()=>d(e.error)})}let w=new Map,x=new FinalizationRegistry(a=>{w.delete(a)});function y(a,b){if("undefined"==typeof WeakRef)return;let c=new WeakRef(b);w.set(a,c);try{x.register(b,a,b)}catch(a){console.log(a)}}function z(a){let b=w.get(a);if(!b)return null;let c=b.deref();return c||(w.delete(a),null)}function A(a){w.delete(a)}var B=a.i(40490);function C({item:a,engine:d,onUpdate:f,onDelete:g}){let[h,n]=(0,c.useState)(!1),[r,s]=(0,c.useState)(!1),[w,x]=(0,c.useState)(!1),[C,D]=(0,c.useState)(!1),E=(0,c.useRef)([]),F=(0,c.useRef)(null),G=async()=>{let b=async(b,c)=>{"success"===b.status?(await t(a.uuid,c),y(a.uuid,c),f({...a,recognized:b.data,modified_db:!0,modified_fs:!0})):m.toast.error(b.error)};a.modified_fs&&(await v(a.uuid),A(a.uuid)),await (0,l.toggleRecording)(h,n,E,F,!0,d,s,a=>{console.log(a)},b)},H=async()=>{if(a.modified_fs&&(await v(a.uuid),A(a.uuid)),a.on_fs){if("success"!==(await o("reading",`${a.uuid}.wav`)).status)return void m.toast.error("delete audio failed");m.toast.success("delete audio success")}if(a.in_db){if("success"!==(await p(a.uuid)).status)return void m.toast.error("delete sentence failed");m.toast.success("delete sentence success")}g(a.uuid)};return(0,b.jsxs)("div",{className:"flex flex-col items-start justify-start w-full rounded-lg bg-sand-300",children:[(0,b.jsxs)("div",{className:"flex flex-row items-start justify-start w-full my-2",children:[a.modified_db||a.modified_fs?(0,b.jsx)(j.Tooltip,{placement:"bottom",content:"unsaved",children:(0,b.jsx)("div",{className:"text-red-500",children:"â—"})}):(0,b.jsx)("div",{className:"text-transparent",children:"â—"}),(0,b.jsxs)("div",{className:"flex flex-col w-full ps-2",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start w-full",children:[(0,b.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"re-record",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:!h&&r,onPress:G,children:h?(0,b.jsx)(k.MdMic,{size:20}):(0,b.jsx)(k.MdMicOff,{size:20})})}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"play audio",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{if(a.modified_fs){let b=z(a.uuid);if(b||((b=await u(a.uuid))?y(a.uuid,b):m.toast.error("Blob of audio not found")),b){let a=URL.createObjectURL(b),c=new Audio(a);c.play(),c.onended=()=>{URL.revokeObjectURL(a)}}}else new Audio(a.audio_path).play()},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})})]}),(0,b.jsxs)("div",{className:"flex flex-row items-center justify-end",children:[(0,b.jsx)(j.Tooltip,{placement:"top",content:"show/hide original",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>D(!C),children:C?(0,b.jsx)(k.MdOutlineKeyboardDoubleArrowUp,{size:20}):(0,b.jsx)(k.MdOutlineKeyboardDoubleArrowDown,{size:20})})}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"delete",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",color:"danger",className:"w-fit h-fit",onPress:()=>{window.confirm("Are you sure to delete?")&&H()},children:(0,b.jsx)(k.MdDelete,{size:20})})})]})]}),(0,b.jsx)("div",{className:"text-xl text-balance hyphens-auto",children:(0,B.highlightDifferences)(a.original,a.recognized)})]}),(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center w-fit gap-1",children:[(0,b.jsx)(j.Tooltip,{placement:"left",content:"move upward",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{f({...a,order_num:a.order_num+1,modified_db:!0})},children:(0,b.jsx)(k.MdArrowUpward,{size:20})})}),(0,b.jsx)("div",{children:a.order_num}),(0,b.jsx)(j.Tooltip,{placement:"left",content:"move downward",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{f({...a,order_num:a.order_num-1,modified_db:!0})},children:(0,b.jsx)(k.MdArrowDownward,{size:20})})})]})]}),C&&(0,b.jsx)("div",{className:"flex flex-row items-center justify-start w-full px-2 pb-1",children:(0,b.jsx)(i.Textarea,{size:"lg",className:"w-full",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:a.original,onChange:b=>{f({...a,original:b.target.value,modified_db:!0})},endContent:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:w,onPress:async()=>{let b=`/api/data/tts/${a.uuid}.wav`;if(!await fetch(b,{method:"HEAD"}).then(a=>a.ok).catch(()=>!1)){x(!0);let b=await (0,q.callTTS)(a.uuid,a.original);if(x(!1),"error"===b.status)return void console.error(b.error)}new Audio(b).play().catch(a=>console.error("error: ",a))},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})})})]})}var D=a.i(68114),E=(0,n.createServerReference)("40bda199ec71e32889d6fcb121314d6c75c716b379",n.callServer,void 0,n.findSourceMapURL,"getBookAll"),F=a.i(28577),G=a.i(19915),H=a.i(27493),I=a.i(75090);function J({user_id:a,onSelect:d}){let[h,i]=(0,c.useState)([]),[j,k]=(0,c.useState)(""),[l,n]=(0,c.useState)(!1),[o,p]=(0,c.useState)(!1),[q,r]=(0,c.useState)(!1),s=async()=>{r(!0);let b=await E(a);"success"===b.status&&i(b.data),r(!1)},t=async()=>{if(!a)return void m.toast.error("not logged in");p(!0),"success"===(await (0,G.saveBook)({uuid:(0,D.getUUID)(),user_id:a,name:j,created_by:a,created_at:new Date,updated_at:new Date})).status?(m.toast.success("save book success"),k("")):m.toast.error("save book failed"),p(!1)},u=async a=>{p(!0),"success"===(await (0,F.removeBook)(a)).status?m.toast.success("delete book success"):m.toast.error("delete book failed"),p(!1)};return(0,c.useEffect)(()=>{s()},[a]),(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsx)(f.Select,{label:"Select book",onChange:async a=>{let b=a.target.value;await d(b)},endContent:q&&(0,b.jsx)(H.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:h.map(a=>(0,b.jsx)(g.SelectItem,{textValue:a.name,children:a.name},a.uuid))}),(0,b.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>n(!l),children:l?"finish":"edit"}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:s,children:"refresh"})]}),l&&(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,b.jsx)(I.Input,{label:"Name of Book",size:"sm",onChange:a=>k(a.target.value)}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",isDisabled:o,onPress:t,children:"add"})]}),h.map(a=>(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start px-2 gap-2 bg-sand-300",children:[a.name,(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>u(a.uuid),children:"delete"})]},a.uuid))]})]})}var K=(0,n.createServerReference)("409dbebe50d74a2b89ab30e0e970160c44fba9b6af",n.callServer,void 0,n.findSourceMapURL,"getSentenceAll"),L=(0,n.createServerReference)("409a32bb7a5d4115f0d7caa71341d9a65d3b4774cf",n.callServer,void 0,n.findSourceMapURL,"saveSentence"),M=(0,n.createServerReference)("40e4faccb7a409bd40a13531c418513502b2d41b3f",n.callServer,void 0,n.findSourceMapURL,"getChapterAll"),N=(0,n.createServerReference)("40666789af413a64a6482017803e4852f7571f6ee1",n.callServer,void 0,n.findSourceMapURL,"removeChapter"),O=(0,n.createServerReference)("405d8a59b21d25ce2971debb89cce2579825181e14",n.callServer,void 0,n.findSourceMapURL,"saveChapter");function P({user_id:a,book_uuid:d,onSelect:h}){let[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)(""),[n,o]=(0,c.useState)(""),[p,q]=(0,c.useState)(!1),[r,s]=(0,c.useState)(!1),[t,u]=(0,c.useState)(!1),v=async()=>{u(!0);let a=await M(d);"success"===a.status&&j(a.data),u(!1)},w=async()=>a?d?void(s(!0),"success"===(await O({uuid:(0,D.getUUID)(),book_uuid:d,order_num:parseInt(k,10),name:n,created_by:a,created_at:new Date,updated_at:new Date})).status?(m.toast.success("save chapter success"),o("")):m.toast.error("save chapter failed"),s(!1)):void m.toast.error("no book selected"):void m.toast.error("not logged in"),x=async a=>{s(!0),"success"===(await N(a)).status?m.toast.success("delete chapter success"):m.toast.error("delete chapter failed"),s(!1)};return(0,c.useEffect)(()=>{v()},[d]),(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsx)(f.Select,{label:"Select chapter",onChange:async a=>{let b=a.target.value;await h(b)},endContent:t&&(0,b.jsx)(H.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:i.map(a=>(0,b.jsxs)(g.SelectItem,{textValue:`${a.order_num}, ${a.name}`,children:[a.order_num,", ",a.name]},a.uuid))}),(0,b.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>q(!p),children:p?"finish":"edit"}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:v,children:"refresh"})]}),p&&(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,b.jsx)(I.Input,{label:"Order",type:"number",size:"sm",className:"w-1/5",onChange:a=>l(a.target.value)}),(0,b.jsx)(I.Input,{label:"Name of Book",size:"sm",onChange:a=>o(a.target.value)}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",isDisabled:r,onPress:w,children:"add"})]}),i.map(a=>(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2 bg-sand-300",children:[a.order_num," - ",a.name,(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>x(a.uuid),children:"delete"})]},a.uuid))]})]})}var Q=(0,n.createServerReference)("709441492527acb009ef1d59f55c7ed0e7c5e1e3f2",n.callServer,void 0,n.findSourceMapURL,"saveAudio");function R({email:a}){let[j,n]=(0,c.useState)(""),[o,p]=(0,c.useState)(""),[q,r]=(0,c.useState)("local"),[s,w]=(0,c.useState)(!1),[x,E]=(0,c.useState)(!1),[F,G]=(0,c.useState)(),[H,I]=(0,d.useImmer)([]),[M,N]=(0,c.useState)(!1),[O,R]=(0,c.useState)(!1),[S,T]=(0,c.useState)(!1),U=(0,c.useRef)([]),V=(0,c.useRef)(null),W=(0,c.useMemo)(()=>H.slice().reverse(),[H]),X=async a=>{R(!0);let b=await K(a);if("success"===b.status){let a=b.data.map((a,b)=>(a.order_num!==b+1&&N(!0),{...(0,D.toExactType)(a),order_num:b+1,in_db:!0,on_fs:!0,modified_db:a.order_num!==b+1,modified_fs:!1}));I(b=>{for(let c of(b.length=0,a))b.push(c)})}R(!1)},Y=a=>{I(b=>{let c=b.findIndex(b=>b.uuid===a.uuid);if(-1!==c){if(b[c].order_num!==a.order_num){b.splice(c,1);let d=Math.max(0,Math.min(b.length,a.order_num-1));b.splice(d,0,{...a})}else b[c]={...a};b.forEach((a,b)=>{a.modified_db||a.order_num===b+1||(a.modified_db=a.order_num!==b+1),a.order_num=b+1})}}),N(!0)},Z=a=>{I(b=>{let c=b.findIndex(b=>b.uuid===a);-1!==c&&b.splice(c,1),b.forEach((a,b)=>{a.modified_db||a.order_num===b+1||(a.modified_db=a.order_num!==b+1),a.order_num=b+1,a.order_num=b+1})}),N(!0)},$=async()=>{if(!F)return;T(!0);let b=z(F.uuid);if(b||(b=await u(F.uuid)),!b){m.toast.error("Blob of audio not found"),T(!1);return}if("success"===(await Q(b,"reading",`${F.uuid}.wav`)).status)await v(F.uuid),A(F.uuid);else{m.toast.error("save audio failed"),T(!1);return}if("error"===(await L({uuid:F.uuid,chapter_uuid:F.chapter_uuid,order_num:F.order_num,original:F.original,recognized:F.recognized,audio_path:`/api/data/reading/${F.uuid}.wav`,created_by:a,created_at:F.created_at||new Date,updated_at:new Date})).status){m.toast.error("save db failed"),T(!1);return}I(a=>{a.push({...F,in_db:!0,on_fs:!0,modified_db:!1,modified_fs:!1})}),G(void 0),m.toast.success("added and saved successfully!"),T(!1)},_=async()=>{T(!0);try{for(let b of H){if(b.modified_fs){let a=z(b.uuid);if(a||(a=await u(b.uuid)),!a)throw Error(`${b.order_num}: Blob of audio not found`);let c=await Q(a,"reading",`${b.uuid}.wav`);if("success"===c.status)await v(b.uuid),A(b.uuid),I(a=>{let c=a.find(a=>a.uuid===b.uuid);c&&(c.on_fs=!0,c.modified_fs=!1)});else throw Error(`${b.order_num}: save audio failed`)}let c=await L({uuid:b.uuid,chapter_uuid:b.chapter_uuid,order_num:b.order_num,original:b.original,recognized:b.recognized,audio_path:b.audio_path,created_by:a,created_at:b.created_at||new Date,updated_at:new Date});if("error"===c.status)throw Error("save sentence failed");I(a=>{let c=a.find(a=>a.uuid===b.uuid);c&&(c.in_db=!0,c.modified_db=!1)})}N(!1),m.toast.success("All sentences saved successfully!")}catch(a){m.toast.error(a.message||"Failed to save sentences")}T(!1)},aa=async()=>{let a=async(a,b)=>{if("success"===a.status){let c=(0,D.getUUID)();await t(c,b),y(c,b),G({uuid:c,chapter_uuid:o,order_num:H.length+1,original:a.data,recognized:a.data,audio_path:`/api/data/reading/${c}.wav`,in_db:!1,on_fs:!1,modified_db:!0,modified_fs:!0})}else m.toast.error(a.error)};await (0,l.toggleRecording)(s,w,U,V,!0,q,E,a=>{console.log(a)},a)};return(0,c.useEffect)(()=>{let a=a=>{if(a.ctrlKey&&"a"===a.key){a.preventDefault();let b=document.getElementById("button-toggel-recording");b?.click()}if(a.ctrlKey&&"s"===a.key){a.preventDefault();let b=document.getElementById("button-add-save");b?.click()}};return document.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},[s,x]),(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex flex-col md:flex-row gap-4 my-4",children:[(0,b.jsx)(J,{user_id:a,onSelect:async a=>{n(a)}}),(0,b.jsx)(P,{user_id:a,book_uuid:j,onSelect:async a=>{p(a),G(void 0),N(!1),await X(a)}})]}),(0,b.jsxs)("div",{className:"flex flex-col md:flex-row items-center justify-center gap-4 my-4",children:[(0,b.jsx)(f.Select,{className:"max-w-sm",selectedKeys:[q],onChange:a=>r(a.target.value),startContent:(0,b.jsx)("div",{className:"whitespace-nowrap font-bold",children:"AI Engine"}),children:l.EngineList.map(a=>(0,b.jsx)(g.SelectItem,{textValue:a.value,children:a.value},a.key))}),(0,b.jsx)(e.Button,{variant:"solid",color:"primary",id:"button-toggel-recording",isDisabled:!s&&x,onPress:async()=>{j&&o?(F&&G(void 0),await aa()):alert("select book and chapter first")},children:s?"â¹ Stop Recording (Ctrl+A)":x?"Processing":"ðŸŽ¤ Read a Sentence (Ctrl+A)"})]}),F&&(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center w-full gap-2 my-4",children:[(0,b.jsxs)("div",{className:"flex flex-col w-full p-2 rounded-lg bg-sand-300",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,b.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{let a=z(F.uuid);if(a||((a=await u(F.uuid))?y(F.uuid,a):m.toast.error("Blob of audio not found")),a){let b=URL.createObjectURL(a),c=new Audio(b);c.play(),c.onended=()=>{URL.revokeObjectURL(b)}}},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})]}),(0,b.jsx)("div",{className:"text-xl",children:(0,B.highlightDifferences)(F.original,F.recognized)}),(0,b.jsx)(i.Textarea,{size:"lg",className:"w-full",label:"original text",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:F.original,onChange:a=>G({...F,original:a.target.value})})]}),(0,b.jsx)(e.Button,{variant:"solid",color:"primary",id:"button-add-save",isDisabled:S,onPress:$,children:"Add & Save (Ctrl+S)"})]}),O&&(0,b.jsx)("div",{className:"flex flex-row w-full items-center justify-center gap-4 my-4",children:(0,b.jsx)(h.Spinner,{classNames:{label:"text-foreground mt-4"},variant:"simple"})}),M&&(0,b.jsx)("div",{className:"flex flex-row items-center justify-end my-4 mb-0",children:(0,b.jsx)(e.Button,{variant:"solid",color:"primary",isDisabled:S,onPress:_,children:"Save"})}),H.length>0&&(0,b.jsx)("div",{className:"flex flex-col w-full gap-4 my-4",children:W.map((a,c)=>(0,b.jsx)(C,{item:a,engine:q,onUpdate:Y,onDelete:Z},`${c}-${a.uuid}`))})]})}}];

//# sourceMappingURL=src_app_speak_read_client_tsx_94ddbbc1._.js.map