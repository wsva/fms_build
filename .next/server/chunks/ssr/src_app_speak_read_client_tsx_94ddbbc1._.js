module.exports=[58041,a=>{"use strict";a.s(["default",()=>B],58041);var b=a.i(87924),c=a.i(72131),d=a.i(88303),e=a.i(32496),f=a.i(4655),g=a.i(24647),h=a.i(72571),i=a.i(84476),j=a.i(88206),k=a.i(328),l=a.i(84850),m=a.i(20094),n=a.i(68483),o=a.i(80768),p=a.i(85539),q=a.i(40490);function r({item:a,engine:d,handleUpdate:f,handleDelete:g}){let[h,r]=(0,c.useState)([]),[s,t]=(0,c.useState)(!1),[u,v]=(0,c.useState)(!1),[w,x]=(0,c.useState)(!1),[y,z]=(0,c.useState)(!1),A=async()=>{let b=async(b,c)=>{"success"===b.status?(await (0,o.saveBlobToIndexedDB)(a.uuid,c),(0,p.cacheBlobInMemory)(a.uuid,c),f({...a,recognized:b.data,modified_db:!0,modified_fs:!0})):m.toast.error(b.error)};a.modified_fs&&(await (0,o.deleteBlobFromIndexedDB)(a.uuid),(0,p.dropWeakCache)(a.uuid)),await (0,l.toggleRecording)({mode:"audio",stateRecorder:h,setStateRecorder:r,stateRecording:s,setStateRecording:t,recognize:!0,sttEngine:d,setStateProcessing:v,handleAudio:b})};return(0,b.jsxs)("div",{className:"flex flex-col items-start justify-start w-full rounded-lg bg-sand-300",children:[(0,b.jsxs)("div",{className:"flex flex-row items-start justify-start w-full my-2",children:[a.modified_db||a.modified_fs?(0,b.jsx)(j.Tooltip,{placement:"bottom",content:"unsaved",children:(0,b.jsx)("div",{className:"text-red-500",children:"â—"})}):(0,b.jsx)("div",{className:"text-transparent",children:"â—"}),(0,b.jsxs)("div",{className:"flex flex-col w-full ps-2",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start w-full",children:[(0,b.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"re-record",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:!s&&u,onPress:A,children:s?(0,b.jsx)(k.MdMic,{size:20}):(0,b.jsx)(k.MdMicOff,{size:20})})}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"play audio",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{if(a.modified_fs){let b=(0,p.getBlobFromWeakCache)(a.uuid);if(b||((b=await (0,o.getBlobFromIndexedDB)(a.uuid))?(0,p.cacheBlobInMemory)(a.uuid,b):m.toast.error("Blob of audio not found")),b){let a=URL.createObjectURL(b),c=new Audio(a);c.play(),c.onended=()=>{URL.revokeObjectURL(a)}}}else new Audio(a.audio_path).play()},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})})]}),(0,b.jsxs)("div",{className:"flex flex-row items-center justify-end",children:[(0,b.jsx)(j.Tooltip,{placement:"top",content:"show/hide original",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>z(!y),children:y?(0,b.jsx)(k.MdOutlineKeyboardDoubleArrowUp,{size:20}):(0,b.jsx)(k.MdOutlineKeyboardDoubleArrowDown,{size:20})})}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"delete",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",color:"danger",className:"w-fit h-fit",onPress:async()=>{window.confirm("Are you sure to delete?")&&await g(a)},children:(0,b.jsx)(k.MdDelete,{size:20})})})]})]}),(0,b.jsx)("div",{className:"text-xl text-balance hyphens-auto",children:(0,q.highlightDifferences)(a.original,a.recognized)})]}),(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center w-fit gap-1",children:[(0,b.jsx)(j.Tooltip,{placement:"left",content:"move upward",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{f({...a,order_num:a.order_num+1,modified_db:!0})},children:(0,b.jsx)(k.MdArrowUpward,{size:20})})}),(0,b.jsx)("div",{children:a.order_num}),(0,b.jsx)(j.Tooltip,{placement:"left",content:"move downward",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{f({...a,order_num:a.order_num-1,modified_db:!0})},children:(0,b.jsx)(k.MdArrowDownward,{size:20})})})]})]}),y&&(0,b.jsx)("div",{className:"flex flex-row items-center justify-start w-full px-2 pb-1",children:(0,b.jsx)(i.Textarea,{size:"lg",className:"w-full",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:a.original,onChange:b=>{f({...a,original:b.target.value,modified_db:!0})},endContent:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:w,onPress:async()=>{let b=`/api/data/tts/${a.uuid}.wav`;if(!await fetch(b,{method:"HEAD"}).then(a=>a.ok).catch(()=>!1)){x(!0);let b=await (0,n.callTTS)(a.uuid,a.original);if(x(!1),"error"===b.status)return void console.error(b.error)}new Audio(b).play().catch(a=>console.error("error: ",a))},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})})})]})}var s=a.i(68114),t=a.i(26347),u=a.i(5050),v=(0,u.createServerReference)("40b101ca850fab01c7b5886c305173b3b60c645f2a",u.callServer,void 0,u.findSourceMapURL,"getSentenceAll"),w=(0,u.createServerReference)("40301ccb4bc732abc61856202f1b42a995a7b6339a",u.callServer,void 0,u.findSourceMapURL,"removeSentence"),x=(0,u.createServerReference)("409a267b3cfd857a1446d62b56f91e48a95a487f94",u.callServer,void 0,u.findSourceMapURL,"saveSentence"),y=a.i(71040),z=a.i(85212),A=a.i(31084);function B({email:a}){let[j,n]=(0,c.useState)(""),[u,B]=(0,c.useState)(""),[C,D]=(0,c.useState)("local"),[E,F]=(0,c.useState)([]),[G,H]=(0,c.useState)(!1),[I,J]=(0,c.useState)(!1),[K,L]=(0,c.useState)(),[M,N]=(0,d.useImmer)([]),[O,P]=(0,c.useState)(!1),[Q,R]=(0,c.useState)(!1),[S,T]=(0,c.useState)(!1),U=(0,c.useMemo)(()=>M.slice().reverse(),[M]),V=async a=>{R(!0);let b=await v(a);if("success"===b.status){let a=b.data.map((a,b)=>(a.order_num!==b+1&&P(!0),{...(0,s.toExactType)(a),order_num:b+1,in_db:!0,on_fs:!0,modified_db:a.order_num!==b+1,modified_fs:!1}));N(b=>{for(let c of(b.length=0,a))b.push(c)})}R(!1)},W=a=>{N(b=>{let c=b.findIndex(b=>b.uuid===a.uuid);if(-1!==c){if(b[c].order_num!==a.order_num){b.splice(c,1);let d=Math.max(0,Math.min(b.length,a.order_num-1));b.splice(d,0,{...a})}else b[c]={...a};b.forEach((a,b)=>{a.modified_db||a.order_num===b+1||(a.modified_db=a.order_num!==b+1),a.order_num=b+1})}}),P(!0)},X=async a=>(a.modified_fs&&(await (0,o.deleteBlobFromIndexedDB)(a.uuid),(0,p.dropWeakCache)(a.uuid)),a.on_fs&&"success"!==(await (0,z.removeAudio)("reading",`${a.uuid}.wav`)).status)?void m.toast.error("delete audio failed"):a.in_db&&"success"!==(await w(a.uuid)).status?void m.toast.error("delete sentence failed"):void(N(b=>{let c=b.findIndex(b=>b.uuid===a.uuid);-1!==c&&b.splice(c,1),b.forEach((a,b)=>{a.modified_db||a.order_num===b+1||(a.modified_db=a.order_num!==b+1),a.order_num=b+1,a.order_num=b+1})}),P(!0),m.toast.error("delete sentence success")),Y=async()=>{if(!K)return;T(!0);let b=(0,p.getBlobFromWeakCache)(K.uuid);if(b||(b=await (0,o.getBlobFromIndexedDB)(K.uuid)),!b){m.toast.error("Blob of audio not found"),T(!1);return}if("success"===(await (0,A.saveAudio)(b,"reading",`${K.uuid}.wav`)).status)await (0,o.deleteBlobFromIndexedDB)(K.uuid),(0,p.dropWeakCache)(K.uuid);else{m.toast.error("save audio failed"),T(!1);return}if("error"===(await x({uuid:K.uuid,chapter_uuid:K.chapter_uuid,order_num:K.order_num,original:K.original,recognized:K.recognized,audio_path:`/api/data/reading/${K.uuid}.wav`,created_by:a,created_at:K.created_at||new Date,updated_at:new Date})).status){m.toast.error("save db failed"),T(!1);return}N(a=>{a.push({...K,in_db:!0,on_fs:!0,modified_db:!1,modified_fs:!1})}),L(void 0),m.toast.success("added and saved successfully!"),T(!1)},Z=async()=>{T(!0);try{for(let b of M){if(b.modified_fs){let a=(0,p.getBlobFromWeakCache)(b.uuid);if(a||(a=await (0,o.getBlobFromIndexedDB)(b.uuid)),!a)throw Error(`${b.order_num}: Blob of audio not found`);let c=await (0,A.saveAudio)(a,"reading",`${b.uuid}.wav`);if("success"===c.status)await (0,o.deleteBlobFromIndexedDB)(b.uuid),(0,p.dropWeakCache)(b.uuid),N(a=>{let c=a.find(a=>a.uuid===b.uuid);c&&(c.on_fs=!0,c.modified_fs=!1)});else throw Error(`${b.order_num}: save audio failed`)}let c=await x({uuid:b.uuid,chapter_uuid:b.chapter_uuid,order_num:b.order_num,original:b.original,recognized:b.recognized,audio_path:b.audio_path,created_by:a,created_at:b.created_at||new Date,updated_at:new Date});if("error"===c.status)throw Error("save sentence failed");N(a=>{let c=a.find(a=>a.uuid===b.uuid);c&&(c.in_db=!0,c.modified_db=!1)})}P(!1),m.toast.success("All sentences saved successfully!")}catch(a){m.toast.error(a.message||"Failed to save sentences")}T(!1)},$=async()=>{let a=async(a,b)=>{let c=(0,s.getUUID)();await (0,o.saveBlobToIndexedDB)(c,b),(0,p.cacheBlobInMemory)(c,b),L({uuid:c,chapter_uuid:u,order_num:M.length+1,original:"success"===a.status?a.data:"",recognized:"success"===a.status?a.data:"",audio_path:`/api/data/reading/${c}.wav`,in_db:!1,on_fs:!1,modified_db:!0,modified_fs:!0}),"error"===a.status&&m.toast.error(a.error)};await (0,l.toggleRecording)({mode:"audio",stateRecorder:E,setStateRecorder:F,stateRecording:G,setStateRecording:H,recognize:!0,sttEngine:C,setStateProcessing:J,handleAudio:a})};return(0,c.useEffect)(()=>{let a=a=>{if(a.ctrlKey&&"a"===a.key){a.preventDefault();let b=document.getElementById("button-toggel-recording");b?.click()}if(a.ctrlKey&&"s"===a.key){a.preventDefault();let b=document.getElementById("button-add-save");b?.click()}};return document.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},[G,I]),(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex flex-col md:flex-row gap-4 my-4",children:[(0,b.jsx)(t.default,{user_id:a,onSelect:async a=>{n(a)}}),(0,b.jsx)(y.default,{user_id:a,book_uuid:j,onSelect:async a=>{B(a),L(void 0),P(!1),await V(a)}})]}),(0,b.jsxs)("div",{className:"flex flex-col md:flex-row items-center justify-center gap-4 my-4",children:[(0,b.jsx)(f.Select,{"aria-label":"stt engine",className:"max-w-sm",selectedKeys:[C],onChange:a=>D(a.target.value),startContent:(0,b.jsx)("div",{className:"whitespace-nowrap font-bold",children:"AI Engine"}),children:l.EngineList.map(a=>(0,b.jsx)(g.SelectItem,{textValue:a.value,children:a.value},a.key))}),(0,b.jsx)(e.Button,{variant:"solid",color:"primary",id:"button-toggel-recording",isDisabled:!G&&I,onPress:async()=>{j&&u?(K&&L(void 0),await $()):alert("select book and chapter first")},children:G?"â¹ Stop Recording (Ctrl+A)":I?"Processing":"ðŸŽ¤ Read a Sentence (Ctrl+A)"})]}),K&&(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center w-full gap-2 my-4",children:[(0,b.jsxs)("div",{className:"flex flex-col w-full p-2 rounded-lg bg-sand-300",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,b.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{let a=(0,p.getBlobFromWeakCache)(K.uuid);if(a||((a=await (0,o.getBlobFromIndexedDB)(K.uuid))?(0,p.cacheBlobInMemory)(K.uuid,a):m.toast.error("Blob of audio not found")),a){let b=URL.createObjectURL(a),c=new Audio(b);c.play(),c.onended=()=>{URL.revokeObjectURL(b)}}},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})]}),(0,b.jsx)("div",{className:"text-xl",children:(0,q.highlightDifferences)(K.original,K.recognized)}),(0,b.jsx)(i.Textarea,{size:"lg",className:"w-full",label:"original text",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:K.original,onChange:a=>L({...K,original:a.target.value})})]}),(0,b.jsx)(e.Button,{variant:"solid",color:"primary",id:"button-add-save",isDisabled:S,onPress:Y,children:"Add & Save (Ctrl+S)"})]}),Q&&(0,b.jsx)("div",{className:"flex flex-row w-full items-center justify-center gap-4 my-4",children:(0,b.jsx)(h.Spinner,{classNames:{label:"text-foreground mt-4"},variant:"simple"})}),O&&(0,b.jsx)("div",{className:"flex flex-row items-center justify-end my-4 mb-0",children:(0,b.jsx)(e.Button,{variant:"solid",color:"primary",isDisabled:S,onPress:Z,children:"Save"})}),M.length>0&&(0,b.jsx)("div",{className:"flex flex-col w-full gap-4 my-4",children:U.map((a,c)=>(0,b.jsx)(r,{item:a,engine:C,handleUpdate:W,handleDelete:X},`${c}-${a.uuid}`))})]})}}];

//# sourceMappingURL=src_app_speak_read_client_tsx_94ddbbc1._.js.map