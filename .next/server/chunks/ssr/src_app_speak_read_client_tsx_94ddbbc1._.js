module.exports=[58041,a=>{"use strict";a.s(["default",()=>J],58041);var b=a.i(87924),c=a.i(72131),d=a.i(88303),e=a.i(32496),f=a.i(4655),g=a.i(24647),h=a.i(72571),i=a.i(84476),j=a.i(88206),k=a.i(328),l=a.i(84850),m=a.i(20094),n=a.i(69220),o=a.i(5050),p=(0,o.createServerReference)("406d57c8287d8f39ce3bcad92d5bfa4aede147e3d8",o.callServer,void 0,o.findSourceMapURL,"removeSentence"),q=a.i(66564),r=a.i(80768),s=a.i(85539),t=a.i(40490);function u({item:a,engine:d,onUpdate:f,onDelete:g}){let[h,o]=(0,c.useState)(!1),[u,v]=(0,c.useState)(!1),[w,x]=(0,c.useState)(!1),[y,z]=(0,c.useState)(!1),A=(0,c.useRef)([]),B=(0,c.useRef)(null),C=async()=>{let b=async(b,c)=>{"success"===b.status?(await (0,r.saveBlobToIndexedDB)(a.uuid,c),(0,s.cacheBlobInMemory)(a.uuid,c),f({...a,recognized:b.data,modified_db:!0,modified_fs:!0})):m.toast.error(b.error)};a.modified_fs&&(await (0,r.deleteBlobFromIndexedDB)(a.uuid),(0,s.dropWeakCache)(a.uuid)),await (0,l.toggleRecording)(h,o,A,B,!0,d,v,a=>{console.log(a)},b)},D=async()=>{if(a.modified_fs&&(await (0,r.deleteBlobFromIndexedDB)(a.uuid),(0,s.dropWeakCache)(a.uuid)),a.on_fs){if("success"!==(await (0,n.removeAudio)("reading",`${a.uuid}.wav`)).status)return void m.toast.error("delete audio failed");m.toast.success("delete audio success")}if(a.in_db){if("success"!==(await p(a.uuid)).status)return void m.toast.error("delete sentence failed");m.toast.success("delete sentence success")}g(a.uuid)};return(0,b.jsxs)("div",{className:"flex flex-col items-start justify-start w-full rounded-lg bg-sand-300",children:[(0,b.jsxs)("div",{className:"flex flex-row items-start justify-start w-full my-2",children:[a.modified_db||a.modified_fs?(0,b.jsx)(j.Tooltip,{placement:"bottom",content:"unsaved",children:(0,b.jsx)("div",{className:"text-red-500",children:"â—"})}):(0,b.jsx)("div",{className:"text-transparent",children:"â—"}),(0,b.jsxs)("div",{className:"flex flex-col w-full ps-2",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start w-full",children:[(0,b.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"re-record",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:!h&&u,onPress:C,children:h?(0,b.jsx)(k.MdMic,{size:20}):(0,b.jsx)(k.MdMicOff,{size:20})})}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"play audio",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{if(a.modified_fs){let b=(0,s.getBlobFromWeakCache)(a.uuid);if(b||((b=await (0,r.getBlobFromIndexedDB)(a.uuid))?(0,s.cacheBlobInMemory)(a.uuid,b):m.toast.error("Blob of audio not found")),b){let a=URL.createObjectURL(b),c=new Audio(a);c.play(),c.onended=()=>{URL.revokeObjectURL(a)}}}else new Audio(a.audio_path).play()},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})})]}),(0,b.jsxs)("div",{className:"flex flex-row items-center justify-end",children:[(0,b.jsx)(j.Tooltip,{placement:"top",content:"show/hide original",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>z(!y),children:y?(0,b.jsx)(k.MdOutlineKeyboardDoubleArrowUp,{size:20}):(0,b.jsx)(k.MdOutlineKeyboardDoubleArrowDown,{size:20})})}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"delete",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",color:"danger",className:"w-fit h-fit",onPress:()=>{window.confirm("Are you sure to delete?")&&D()},children:(0,b.jsx)(k.MdDelete,{size:20})})})]})]}),(0,b.jsx)("div",{className:"text-xl text-balance hyphens-auto",children:(0,t.highlightDifferences)(a.original,a.recognized)})]}),(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center w-fit gap-1",children:[(0,b.jsx)(j.Tooltip,{placement:"left",content:"move upward",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{f({...a,order_num:a.order_num+1,modified_db:!0})},children:(0,b.jsx)(k.MdArrowUpward,{size:20})})}),(0,b.jsx)("div",{children:a.order_num}),(0,b.jsx)(j.Tooltip,{placement:"left",content:"move downward",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{f({...a,order_num:a.order_num-1,modified_db:!0})},children:(0,b.jsx)(k.MdArrowDownward,{size:20})})})]})]}),y&&(0,b.jsx)("div",{className:"flex flex-row items-center justify-start w-full px-2 pb-1",children:(0,b.jsx)(i.Textarea,{size:"lg",className:"w-full",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:a.original,onChange:b=>{f({...a,original:b.target.value,modified_db:!0})},endContent:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:w,onPress:async()=>{let b=`/api/data/tts/${a.uuid}.wav`;if(!await fetch(b,{method:"HEAD"}).then(a=>a.ok).catch(()=>!1)){x(!0);let b=await (0,q.callTTS)(a.uuid,a.original);if(x(!1),"error"===b.status)return void console.error(b.error)}new Audio(b).play().catch(a=>console.error("error: ",a))},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})})})]})}var v=a.i(68114),w=(0,o.createServerReference)("405442dbed2e300d62ec27438bc78fd355f1b71566",o.callServer,void 0,o.findSourceMapURL,"getBookAll"),x=a.i(28905),y=a.i(34922),z=a.i(27493),A=a.i(75090);function B({user_id:a,onSelect:d}){let[h,i]=(0,c.useState)([]),[j,k]=(0,c.useState)(""),[l,n]=(0,c.useState)(!1),[o,p]=(0,c.useState)(!1),[q,r]=(0,c.useState)(!1),s=async()=>{r(!0);let b=await w(a);"success"===b.status&&i(b.data),r(!1)},t=async()=>{if(!a)return void m.toast.error("not logged in");p(!0),"success"===(await (0,y.saveBook)({uuid:(0,v.getUUID)(),user_id:a,name:j,created_by:a,created_at:new Date,updated_at:new Date})).status?(m.toast.success("save book success"),k("")):m.toast.error("save book failed"),p(!1)},u=async a=>{p(!0),"success"===(await (0,x.removeBook)(a)).status?m.toast.success("delete book success"):m.toast.error("delete book failed"),p(!1)};return(0,c.useEffect)(()=>{s()},[a]),(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsx)(f.Select,{label:"Select book",onChange:async a=>{let b=a.target.value;await d(b)},endContent:q&&(0,b.jsx)(z.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:h.map(a=>(0,b.jsx)(g.SelectItem,{textValue:a.name,children:a.name},a.uuid))}),(0,b.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>n(!l),children:l?"finish":"edit"}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:s,children:"refresh"})]}),l&&(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,b.jsx)(A.Input,{label:"Name of Book",size:"sm",onChange:a=>k(a.target.value)}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",isDisabled:o,onPress:t,children:"add"})]}),h.map(a=>(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start px-2 gap-2 bg-sand-300",children:[a.name,(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>u(a.uuid),children:"delete"})]},a.uuid))]})]})}var C=(0,o.createServerReference)("40d3790d347a4e1c49b00f60e8d5def40506bde46a",o.callServer,void 0,o.findSourceMapURL,"getSentenceAll"),D=(0,o.createServerReference)("4058c4deafeaaaef6f0cb6b62928c08b1074cca779",o.callServer,void 0,o.findSourceMapURL,"saveSentence"),E=(0,o.createServerReference)("4009be290083ce36a4df8b096c184d06149b38435d",o.callServer,void 0,o.findSourceMapURL,"getChapterAll"),F=(0,o.createServerReference)("404fb2ce4f1722e0a44fc234d3c6615119e64483a5",o.callServer,void 0,o.findSourceMapURL,"removeChapter"),G=(0,o.createServerReference)("405291916443ed2971e7c577916459d664f89c7300",o.callServer,void 0,o.findSourceMapURL,"saveChapter");function H({user_id:a,book_uuid:d,onSelect:h}){let[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)(""),[n,o]=(0,c.useState)(""),[p,q]=(0,c.useState)(!1),[r,s]=(0,c.useState)(!1),[t,u]=(0,c.useState)(!1),w=async()=>{u(!0);let a=await E(d);"success"===a.status&&j(a.data),u(!1)},x=async()=>a?d?void(s(!0),"success"===(await G({uuid:(0,v.getUUID)(),book_uuid:d,order_num:parseInt(k,10),name:n,created_by:a,created_at:new Date,updated_at:new Date})).status?(m.toast.success("save chapter success"),o("")):m.toast.error("save chapter failed"),s(!1)):void m.toast.error("no book selected"):void m.toast.error("not logged in"),y=async a=>{s(!0),"success"===(await F(a)).status?m.toast.success("delete chapter success"):m.toast.error("delete chapter failed"),s(!1)};return(0,c.useEffect)(()=>{w()},[d]),(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsx)(f.Select,{label:"Select chapter",onChange:async a=>{let b=a.target.value;await h(b)},endContent:t&&(0,b.jsx)(z.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:i.map(a=>(0,b.jsxs)(g.SelectItem,{textValue:`${a.order_num}, ${a.name}`,children:[a.order_num,", ",a.name]},a.uuid))}),(0,b.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>q(!p),children:p?"finish":"edit"}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:w,children:"refresh"})]}),p&&(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,b.jsx)(A.Input,{label:"Order",type:"number",size:"sm",className:"w-1/5",onChange:a=>l(a.target.value)}),(0,b.jsx)(A.Input,{label:"Name of Book",size:"sm",onChange:a=>o(a.target.value)}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",isDisabled:r,onPress:x,children:"add"})]}),i.map(a=>(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2 bg-sand-300",children:[a.order_num," - ",a.name,(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>y(a.uuid),children:"delete"})]},a.uuid))]})]})}var I=a.i(42793);function J({email:a}){let[j,n]=(0,c.useState)(""),[o,p]=(0,c.useState)(""),[q,w]=(0,c.useState)("local"),[x,y]=(0,c.useState)(!1),[z,A]=(0,c.useState)(!1),[E,F]=(0,c.useState)(),[G,J]=(0,d.useImmer)([]),[K,L]=(0,c.useState)(!1),[M,N]=(0,c.useState)(!1),[O,P]=(0,c.useState)(!1),Q=(0,c.useRef)([]),R=(0,c.useRef)(null),S=(0,c.useMemo)(()=>G.slice().reverse(),[G]),T=async a=>{N(!0);let b=await C(a);if("success"===b.status){let a=b.data.map((a,b)=>(a.order_num!==b+1&&L(!0),{...(0,v.toExactType)(a),order_num:b+1,in_db:!0,on_fs:!0,modified_db:a.order_num!==b+1,modified_fs:!1}));J(b=>{for(let c of(b.length=0,a))b.push(c)})}N(!1)},U=a=>{J(b=>{let c=b.findIndex(b=>b.uuid===a.uuid);if(-1!==c){if(b[c].order_num!==a.order_num){b.splice(c,1);let d=Math.max(0,Math.min(b.length,a.order_num-1));b.splice(d,0,{...a})}else b[c]={...a};b.forEach((a,b)=>{a.modified_db||a.order_num===b+1||(a.modified_db=a.order_num!==b+1),a.order_num=b+1})}}),L(!0)},V=a=>{J(b=>{let c=b.findIndex(b=>b.uuid===a);-1!==c&&b.splice(c,1),b.forEach((a,b)=>{a.modified_db||a.order_num===b+1||(a.modified_db=a.order_num!==b+1),a.order_num=b+1,a.order_num=b+1})}),L(!0)},W=async()=>{if(!E)return;P(!0);let b=(0,s.getBlobFromWeakCache)(E.uuid);if(b||(b=await (0,r.getBlobFromIndexedDB)(E.uuid)),!b){m.toast.error("Blob of audio not found"),P(!1);return}if("success"===(await (0,I.saveAudio)(b,"reading",`${E.uuid}.wav`)).status)await (0,r.deleteBlobFromIndexedDB)(E.uuid),(0,s.dropWeakCache)(E.uuid);else{m.toast.error("save audio failed"),P(!1);return}if("error"===(await D({uuid:E.uuid,chapter_uuid:E.chapter_uuid,order_num:E.order_num,original:E.original,recognized:E.recognized,audio_path:`/api/data/reading/${E.uuid}.wav`,created_by:a,created_at:E.created_at||new Date,updated_at:new Date})).status){m.toast.error("save db failed"),P(!1);return}J(a=>{a.push({...E,in_db:!0,on_fs:!0,modified_db:!1,modified_fs:!1})}),F(void 0),m.toast.success("added and saved successfully!"),P(!1)},X=async()=>{P(!0);try{for(let b of G){if(b.modified_fs){let a=(0,s.getBlobFromWeakCache)(b.uuid);if(a||(a=await (0,r.getBlobFromIndexedDB)(b.uuid)),!a)throw Error(`${b.order_num}: Blob of audio not found`);let c=await (0,I.saveAudio)(a,"reading",`${b.uuid}.wav`);if("success"===c.status)await (0,r.deleteBlobFromIndexedDB)(b.uuid),(0,s.dropWeakCache)(b.uuid),J(a=>{let c=a.find(a=>a.uuid===b.uuid);c&&(c.on_fs=!0,c.modified_fs=!1)});else throw Error(`${b.order_num}: save audio failed`)}let c=await D({uuid:b.uuid,chapter_uuid:b.chapter_uuid,order_num:b.order_num,original:b.original,recognized:b.recognized,audio_path:b.audio_path,created_by:a,created_at:b.created_at||new Date,updated_at:new Date});if("error"===c.status)throw Error("save sentence failed");J(a=>{let c=a.find(a=>a.uuid===b.uuid);c&&(c.in_db=!0,c.modified_db=!1)})}L(!1),m.toast.success("All sentences saved successfully!")}catch(a){m.toast.error(a.message||"Failed to save sentences")}P(!1)},Y=async()=>{let a=async(a,b)=>{if("success"===a.status){let c=(0,v.getUUID)();await (0,r.saveBlobToIndexedDB)(c,b),(0,s.cacheBlobInMemory)(c,b),F({uuid:c,chapter_uuid:o,order_num:G.length+1,original:a.data,recognized:a.data,audio_path:`/api/data/reading/${c}.wav`,in_db:!1,on_fs:!1,modified_db:!0,modified_fs:!0})}else m.toast.error(a.error)};await (0,l.toggleRecording)(x,y,Q,R,!0,q,A,a=>{console.log(a)},a)};return(0,c.useEffect)(()=>{let a=a=>{if(a.ctrlKey&&"a"===a.key){a.preventDefault();let b=document.getElementById("button-toggel-recording");b?.click()}if(a.ctrlKey&&"s"===a.key){a.preventDefault();let b=document.getElementById("button-add-save");b?.click()}};return document.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},[x,z]),(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex flex-col md:flex-row gap-4 my-4",children:[(0,b.jsx)(B,{user_id:a,onSelect:async a=>{n(a)}}),(0,b.jsx)(H,{user_id:a,book_uuid:j,onSelect:async a=>{p(a),F(void 0),L(!1),await T(a)}})]}),(0,b.jsxs)("div",{className:"flex flex-col md:flex-row items-center justify-center gap-4 my-4",children:[(0,b.jsx)(f.Select,{className:"max-w-sm",selectedKeys:[q],onChange:a=>w(a.target.value),startContent:(0,b.jsx)("div",{className:"whitespace-nowrap font-bold",children:"AI Engine"}),children:l.EngineList.map(a=>(0,b.jsx)(g.SelectItem,{textValue:a.value,children:a.value},a.key))}),(0,b.jsx)(e.Button,{variant:"solid",color:"primary",id:"button-toggel-recording",isDisabled:!x&&z,onPress:async()=>{j&&o?(E&&F(void 0),await Y()):alert("select book and chapter first")},children:x?"â¹ Stop Recording (Ctrl+A)":z?"Processing":"ðŸŽ¤ Read a Sentence (Ctrl+A)"})]}),E&&(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center w-full gap-2 my-4",children:[(0,b.jsxs)("div",{className:"flex flex-col w-full p-2 rounded-lg bg-sand-300",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,b.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{let a=(0,s.getBlobFromWeakCache)(E.uuid);if(a||((a=await (0,r.getBlobFromIndexedDB)(E.uuid))?(0,s.cacheBlobInMemory)(E.uuid,a):m.toast.error("Blob of audio not found")),a){let b=URL.createObjectURL(a),c=new Audio(b);c.play(),c.onended=()=>{URL.revokeObjectURL(b)}}},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})]}),(0,b.jsx)("div",{className:"text-xl",children:(0,t.highlightDifferences)(E.original,E.recognized)}),(0,b.jsx)(i.Textarea,{size:"lg",className:"w-full",label:"original text",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:E.original,onChange:a=>F({...E,original:a.target.value})})]}),(0,b.jsx)(e.Button,{variant:"solid",color:"primary",id:"button-add-save",isDisabled:O,onPress:W,children:"Add & Save (Ctrl+S)"})]}),M&&(0,b.jsx)("div",{className:"flex flex-row w-full items-center justify-center gap-4 my-4",children:(0,b.jsx)(h.Spinner,{classNames:{label:"text-foreground mt-4"},variant:"simple"})}),K&&(0,b.jsx)("div",{className:"flex flex-row items-center justify-end my-4 mb-0",children:(0,b.jsx)(e.Button,{variant:"solid",color:"primary",isDisabled:O,onPress:X,children:"Save"})}),G.length>0&&(0,b.jsx)("div",{className:"flex flex-col w-full gap-4 my-4",children:S.map((a,c)=>(0,b.jsx)(u,{item:a,engine:q,onUpdate:U,onDelete:V},`${c}-${a.uuid}`))})]})}}];

//# sourceMappingURL=src_app_speak_read_client_tsx_94ddbbc1._.js.map