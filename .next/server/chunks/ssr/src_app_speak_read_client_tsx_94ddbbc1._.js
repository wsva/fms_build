module.exports=[58041,a=>{"use strict";a.s(["default",()=>J],58041);var b=a.i(87924),c=a.i(72131),d=a.i(88303),e=a.i(32496),f=a.i(4655),g=a.i(24647),h=a.i(72571),i=a.i(84476),j=a.i(88206),k=a.i(328),l=a.i(84850),m=a.i(20094),n=a.i(71344),o=a.i(80768),p=a.i(85539),q=a.i(40490);function r({item:a,engine:d,handleUpdate:f,handleDelete:g}){let[h,r]=(0,c.useState)(!1),[s,t]=(0,c.useState)(!1),[u,v]=(0,c.useState)(!1),[w,x]=(0,c.useState)(!1),y=(0,c.useRef)([]),z=(0,c.useRef)(null),A=async()=>{let b=async(b,c)=>{"success"===b.status?(await (0,o.saveBlobToIndexedDB)(a.uuid,c),(0,p.cacheBlobInMemory)(a.uuid,c),f({...a,recognized:b.data,modified_db:!0,modified_fs:!0})):m.toast.error(b.error)};a.modified_fs&&(await (0,o.deleteBlobFromIndexedDB)(a.uuid),(0,p.dropWeakCache)(a.uuid)),await (0,l.toggleRecording)(h,r,y,z,!0,d,t,a=>{console.log(a)},b)};return(0,b.jsxs)("div",{className:"flex flex-col items-start justify-start w-full rounded-lg bg-sand-300",children:[(0,b.jsxs)("div",{className:"flex flex-row items-start justify-start w-full my-2",children:[a.modified_db||a.modified_fs?(0,b.jsx)(j.Tooltip,{placement:"bottom",content:"unsaved",children:(0,b.jsx)("div",{className:"text-red-500",children:"â—"})}):(0,b.jsx)("div",{className:"text-transparent",children:"â—"}),(0,b.jsxs)("div",{className:"flex flex-col w-full ps-2",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start w-full",children:[(0,b.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"re-record",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:!h&&s,onPress:A,children:h?(0,b.jsx)(k.MdMic,{size:20}):(0,b.jsx)(k.MdMicOff,{size:20})})}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"play audio",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{if(a.modified_fs){let b=(0,p.getBlobFromWeakCache)(a.uuid);if(b||((b=await (0,o.getBlobFromIndexedDB)(a.uuid))?(0,p.cacheBlobInMemory)(a.uuid,b):m.toast.error("Blob of audio not found")),b){let a=URL.createObjectURL(b),c=new Audio(a);c.play(),c.onended=()=>{URL.revokeObjectURL(a)}}}else new Audio(a.audio_path).play()},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})})]}),(0,b.jsxs)("div",{className:"flex flex-row items-center justify-end",children:[(0,b.jsx)(j.Tooltip,{placement:"top",content:"show/hide original",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>x(!w),children:w?(0,b.jsx)(k.MdOutlineKeyboardDoubleArrowUp,{size:20}):(0,b.jsx)(k.MdOutlineKeyboardDoubleArrowDown,{size:20})})}),(0,b.jsx)(j.Tooltip,{placement:"top",content:"delete",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",color:"danger",className:"w-fit h-fit",onPress:()=>{window.confirm("Are you sure to delete?")&&g(a)},children:(0,b.jsx)(k.MdDelete,{size:20})})})]})]}),(0,b.jsx)("div",{className:"text-xl text-balance hyphens-auto",children:(0,q.highlightDifferences)(a.original,a.recognized)})]}),(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center w-fit gap-1",children:[(0,b.jsx)(j.Tooltip,{placement:"left",content:"move upward",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{g({...a,order_num:a.order_num+1,modified_db:!0})},children:(0,b.jsx)(k.MdArrowUpward,{size:20})})}),(0,b.jsx)("div",{children:a.order_num}),(0,b.jsx)(j.Tooltip,{placement:"left",content:"move downward",children:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{g({...a,order_num:a.order_num-1,modified_db:!0})},children:(0,b.jsx)(k.MdArrowDownward,{size:20})})})]})]}),w&&(0,b.jsx)("div",{className:"flex flex-row items-center justify-start w-full px-2 pb-1",children:(0,b.jsx)(i.Textarea,{size:"lg",className:"w-full",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:a.original,onChange:b=>{g({...a,original:b.target.value,modified_db:!0})},endContent:(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:u,onPress:async()=>{let b=`/api/data/tts/${a.uuid}.wav`;if(!await fetch(b,{method:"HEAD"}).then(a=>a.ok).catch(()=>!1)){v(!0);let b=await (0,n.callTTS)(a.uuid,a.original);if(v(!1),"error"===b.status)return void console.error(b.error)}new Audio(b).play().catch(a=>console.error("error: ",a))},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})})})]})}var s=a.i(68114),t=a.i(5050),u=(0,t.createServerReference)("40c22418e594fae4d832f09e6155b092825f7ad3b8",t.callServer,void 0,t.findSourceMapURL,"getBookAll"),v=a.i(6966),w=a.i(8506),x=a.i(27493),y=a.i(75090);function z({user_id:a,onSelect:d}){let[h,i]=(0,c.useState)([]),[j,k]=(0,c.useState)(""),[l,n]=(0,c.useState)(!1),[o,p]=(0,c.useState)(!1),[q,r]=(0,c.useState)(!1),t=async()=>{r(!0);let b=await u(a);"success"===b.status&&i(b.data),r(!1)},z=async()=>{if(!a)return void m.toast.error("not logged in");p(!0),"success"===(await (0,w.saveBook)({uuid:(0,s.getUUID)(),user_id:a,name:j,created_by:a,created_at:new Date,updated_at:new Date})).status?(m.toast.success("save book success"),k("")):m.toast.error("save book failed"),p(!1)},A=async a=>{p(!0),"success"===(await (0,v.removeBook)(a)).status?m.toast.success("delete book success"):m.toast.error("delete book failed"),p(!1)};return(0,c.useEffect)(()=>{t()},[a]),(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsx)(f.Select,{label:"Select book",onChange:async a=>{let b=a.target.value;await d(b)},endContent:q&&(0,b.jsx)(x.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:h.map(a=>(0,b.jsx)(g.SelectItem,{textValue:a.name,children:a.name},a.uuid))}),(0,b.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>n(!l),children:l?"finish":"edit"}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:t,children:"refresh"})]}),l&&(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,b.jsx)(y.Input,{label:"Name of Book",size:"sm",onChange:a=>k(a.target.value)}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",isDisabled:o,onPress:z,children:"add"})]}),h.map(a=>(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start px-2 gap-2 bg-sand-300",children:[a.name,(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>A(a.uuid),children:"delete"})]},a.uuid))]})]})}var A=(0,t.createServerReference)("4016fe8051e8709b1cbe3e49d804e7bae8059e5c06",t.callServer,void 0,t.findSourceMapURL,"getSentenceAll"),B=(0,t.createServerReference)("4095041d385e031600e25c1988995b5faf14b5f898",t.callServer,void 0,t.findSourceMapURL,"removeSentence"),C=(0,t.createServerReference)("40116a67bc669b4572435ad2e4c0a05830d0690ba1",t.callServer,void 0,t.findSourceMapURL,"saveSentence"),D=(0,t.createServerReference)("4036727ca3d07bd20277d80ddfa5d9c63a196f7eb5",t.callServer,void 0,t.findSourceMapURL,"getChapterAll"),E=(0,t.createServerReference)("409d5401905569166411672bb922c7c76bc3cf797e",t.callServer,void 0,t.findSourceMapURL,"removeChapter"),F=(0,t.createServerReference)("40b7b1a7960da176d037adf24fc08d4dea384a9e26",t.callServer,void 0,t.findSourceMapURL,"saveChapter");function G({user_id:a,book_uuid:d,onSelect:h}){let[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)(""),[n,o]=(0,c.useState)(""),[p,q]=(0,c.useState)(!1),[r,t]=(0,c.useState)(!1),[u,v]=(0,c.useState)(!1),w=async()=>{v(!0);let a=await D(d);"success"===a.status&&j(a.data),v(!1)},z=async()=>a?d?void(t(!0),"success"===(await F({uuid:(0,s.getUUID)(),book_uuid:d,order_num:parseInt(k,10),name:n,created_by:a,created_at:new Date,updated_at:new Date})).status?(m.toast.success("save chapter success"),o("")):m.toast.error("save chapter failed"),t(!1)):void m.toast.error("no book selected"):void m.toast.error("not logged in"),A=async a=>{t(!0),"success"===(await E(a)).status?m.toast.success("delete chapter success"):m.toast.error("delete chapter failed"),t(!1)};return(0,c.useEffect)(()=>{w()},[d]),(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsx)(f.Select,{label:"Select chapter",onChange:async a=>{let b=a.target.value;await h(b)},endContent:u&&(0,b.jsx)(x.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:i.map(a=>(0,b.jsxs)(g.SelectItem,{textValue:`${a.order_num}, ${a.name}`,children:[a.order_num,", ",a.name]},a.uuid))}),(0,b.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>q(!p),children:p?"finish":"edit"}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:w,children:"refresh"})]}),p&&(0,b.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,b.jsx)(y.Input,{label:"Order",type:"number",size:"sm",className:"w-1/5",onChange:a=>l(a.target.value)}),(0,b.jsx)(y.Input,{label:"Name of Book",size:"sm",onChange:a=>o(a.target.value)}),(0,b.jsx)(e.Button,{size:"sm",radius:"full",isDisabled:r,onPress:z,children:"add"})]}),i.map(a=>(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2 bg-sand-300",children:[a.order_num," - ",a.name,(0,b.jsx)(e.Button,{size:"sm",radius:"full",onPress:()=>A(a.uuid),children:"delete"})]},a.uuid))]})]})}var H=a.i(62561),I=a.i(11747);function J({email:a}){let[j,n]=(0,c.useState)(""),[t,u]=(0,c.useState)(""),[v,w]=(0,c.useState)("local"),[x,y]=(0,c.useState)(!1),[D,E]=(0,c.useState)(!1),[F,J]=(0,c.useState)(),[K,L]=(0,d.useImmer)([]),[M,N]=(0,c.useState)(!1),[O,P]=(0,c.useState)(!1),[Q,R]=(0,c.useState)(!1),S=(0,c.useRef)([]),T=(0,c.useRef)(null),U=(0,c.useMemo)(()=>K.slice().reverse(),[K]),V=async a=>{P(!0);let b=await A(a);if("success"===b.status){let a=b.data.map((a,b)=>(a.order_num!==b+1&&N(!0),{...(0,s.toExactType)(a),order_num:b+1,in_db:!0,on_fs:!0,modified_db:a.order_num!==b+1,modified_fs:!1}));L(b=>{for(let c of(b.length=0,a))b.push(c)})}P(!1)},W=a=>{L(b=>{let c=b.findIndex(b=>b.uuid===a.uuid);if(-1!==c){if(b[c].order_num!==a.order_num){b.splice(c,1);let d=Math.max(0,Math.min(b.length,a.order_num-1));b.splice(d,0,{...a})}else b[c]={...a};b.forEach((a,b)=>{a.modified_db||a.order_num===b+1||(a.modified_db=a.order_num!==b+1),a.order_num=b+1})}}),N(!0)},X=async a=>(a.modified_fs&&(await (0,o.deleteBlobFromIndexedDB)(a.uuid),(0,p.dropWeakCache)(a.uuid)),a.on_fs&&"success"!==(await (0,H.removeAudio)("reading",`${a.uuid}.wav`)).status)?void m.toast.error("delete audio failed"):a.in_db&&"success"!==(await B(a.uuid)).status?void m.toast.error("delete sentence failed"):void(L(b=>{let c=b.findIndex(b=>b.uuid===a.uuid);-1!==c&&b.splice(c,1),b.forEach((a,b)=>{a.modified_db||a.order_num===b+1||(a.modified_db=a.order_num!==b+1),a.order_num=b+1,a.order_num=b+1})}),N(!0),m.toast.error("delete sentence success")),Y=async()=>{if(!F)return;R(!0);let b=(0,p.getBlobFromWeakCache)(F.uuid);if(b||(b=await (0,o.getBlobFromIndexedDB)(F.uuid)),!b){m.toast.error("Blob of audio not found"),R(!1);return}if("success"===(await (0,I.saveAudio)(b,"reading",`${F.uuid}.wav`)).status)await (0,o.deleteBlobFromIndexedDB)(F.uuid),(0,p.dropWeakCache)(F.uuid);else{m.toast.error("save audio failed"),R(!1);return}if("error"===(await C({uuid:F.uuid,chapter_uuid:F.chapter_uuid,order_num:F.order_num,original:F.original,recognized:F.recognized,audio_path:`/api/data/reading/${F.uuid}.wav`,created_by:a,created_at:F.created_at||new Date,updated_at:new Date})).status){m.toast.error("save db failed"),R(!1);return}L(a=>{a.push({...F,in_db:!0,on_fs:!0,modified_db:!1,modified_fs:!1})}),J(void 0),m.toast.success("added and saved successfully!"),R(!1)},Z=async()=>{R(!0);try{for(let b of K){if(b.modified_fs){let a=(0,p.getBlobFromWeakCache)(b.uuid);if(a||(a=await (0,o.getBlobFromIndexedDB)(b.uuid)),!a)throw Error(`${b.order_num}: Blob of audio not found`);let c=await (0,I.saveAudio)(a,"reading",`${b.uuid}.wav`);if("success"===c.status)await (0,o.deleteBlobFromIndexedDB)(b.uuid),(0,p.dropWeakCache)(b.uuid),L(a=>{let c=a.find(a=>a.uuid===b.uuid);c&&(c.on_fs=!0,c.modified_fs=!1)});else throw Error(`${b.order_num}: save audio failed`)}let c=await C({uuid:b.uuid,chapter_uuid:b.chapter_uuid,order_num:b.order_num,original:b.original,recognized:b.recognized,audio_path:b.audio_path,created_by:a,created_at:b.created_at||new Date,updated_at:new Date});if("error"===c.status)throw Error("save sentence failed");L(a=>{let c=a.find(a=>a.uuid===b.uuid);c&&(c.in_db=!0,c.modified_db=!1)})}N(!1),m.toast.success("All sentences saved successfully!")}catch(a){m.toast.error(a.message||"Failed to save sentences")}R(!1)},$=async()=>{let a=async(a,b)=>{if("success"===a.status){let c=(0,s.getUUID)();await (0,o.saveBlobToIndexedDB)(c,b),(0,p.cacheBlobInMemory)(c,b),J({uuid:c,chapter_uuid:t,order_num:K.length+1,original:a.data,recognized:a.data,audio_path:`/api/data/reading/${c}.wav`,in_db:!1,on_fs:!1,modified_db:!0,modified_fs:!0})}else m.toast.error(a.error)};await (0,l.toggleRecording)(x,y,S,T,!0,v,E,a=>{console.log(a)},a)};return(0,c.useEffect)(()=>{let a=a=>{if(a.ctrlKey&&"a"===a.key){a.preventDefault();let b=document.getElementById("button-toggel-recording");b?.click()}if(a.ctrlKey&&"s"===a.key){a.preventDefault();let b=document.getElementById("button-add-save");b?.click()}};return document.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},[x,D]),(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex flex-col md:flex-row gap-4 my-4",children:[(0,b.jsx)(z,{user_id:a,onSelect:async a=>{n(a)}}),(0,b.jsx)(G,{user_id:a,book_uuid:j,onSelect:async a=>{u(a),J(void 0),N(!1),await V(a)}})]}),(0,b.jsxs)("div",{className:"flex flex-col md:flex-row items-center justify-center gap-4 my-4",children:[(0,b.jsx)(f.Select,{className:"max-w-sm",selectedKeys:[v],onChange:a=>w(a.target.value),startContent:(0,b.jsx)("div",{className:"whitespace-nowrap font-bold",children:"AI Engine"}),children:l.EngineList.map(a=>(0,b.jsx)(g.SelectItem,{textValue:a.value,children:a.value},a.key))}),(0,b.jsx)(e.Button,{variant:"solid",color:"primary",id:"button-toggel-recording",isDisabled:!x&&D,onPress:async()=>{j&&t?(F&&J(void 0),await $()):alert("select book and chapter first")},children:x?"â¹ Stop Recording (Ctrl+A)":D?"Processing":"ðŸŽ¤ Read a Sentence (Ctrl+A)"})]}),F&&(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center w-full gap-2 my-4",children:[(0,b.jsxs)("div",{className:"flex flex-col w-full p-2 rounded-lg bg-sand-300",children:[(0,b.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,b.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,b.jsx)(e.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{let a=(0,p.getBlobFromWeakCache)(F.uuid);if(a||((a=await (0,o.getBlobFromIndexedDB)(F.uuid))?(0,p.cacheBlobInMemory)(F.uuid,a):m.toast.error("Blob of audio not found")),a){let b=URL.createObjectURL(a),c=new Audio(b);c.play(),c.onended=()=>{URL.revokeObjectURL(b)}}},children:(0,b.jsx)(k.MdPlayCircle,{size:20})})]}),(0,b.jsx)("div",{className:"text-xl",children:(0,q.highlightDifferences)(F.original,F.recognized)}),(0,b.jsx)(i.Textarea,{size:"lg",className:"w-full",label:"original text",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:F.original,onChange:a=>J({...F,original:a.target.value})})]}),(0,b.jsx)(e.Button,{variant:"solid",color:"primary",id:"button-add-save",isDisabled:Q,onPress:Y,children:"Add & Save (Ctrl+S)"})]}),O&&(0,b.jsx)("div",{className:"flex flex-row w-full items-center justify-center gap-4 my-4",children:(0,b.jsx)(h.Spinner,{classNames:{label:"text-foreground mt-4"},variant:"simple"})}),M&&(0,b.jsx)("div",{className:"flex flex-row items-center justify-end my-4 mb-0",children:(0,b.jsx)(e.Button,{variant:"solid",color:"primary",isDisabled:Q,onPress:Z,children:"Save"})}),K.length>0&&(0,b.jsx)("div",{className:"flex flex-col w-full gap-4 my-4",children:U.map((a,c)=>(0,b.jsx)(r,{item:a,engine:v,handleUpdate:W,handleDelete:X},`${c}-${a.uuid}`))})]})}}];

//# sourceMappingURL=src_app_speak_read_client_tsx_94ddbbc1._.js.map