module.exports=[23614,a=>{"use strict";a.s(["default",()=>aE],23614);var b,c=a.i(87924),d=a.i(72131),e=Symbol.for("immer-nothing"),f=Symbol.for("immer-draftable"),g=Symbol.for("immer-state");function h(a){throw Error(`[Immer] minified error nr: ${a}. Full error at: https://bit.ly/3cXEKWf`)}var i=Object.getPrototypeOf;function j(a){return!!a&&!!a[g]}function k(a){return!!a&&(m(a)||Array.isArray(a)||!!a[f]||!!a.constructor?.[f]||r(a)||s(a))}var l=Object.prototype.constructor.toString();function m(a){if(!a||"object"!=typeof a)return!1;let b=i(a);if(null===b)return!0;let c=Object.hasOwnProperty.call(b,"constructor")&&b.constructor;return c===Object||"function"==typeof c&&Function.toString.call(c)===l}function n(a,b){0===o(a)?Reflect.ownKeys(a).forEach(c=>{b(c,a[c],a)}):a.forEach((c,d)=>b(d,c,a))}function o(a){let b=a[g];return b?b.type_:Array.isArray(a)?1:r(a)?2:3*!!s(a)}function p(a,b){return 2===o(a)?a.has(b):Object.prototype.hasOwnProperty.call(a,b)}function q(a,b,c){let d=o(a);2===d?a.set(b,c):3===d?a.add(c):a[b]=c}function r(a){return a instanceof Map}function s(a){return a instanceof Set}function t(a){return a.copy_||a.base_}function u(a,b){if(r(a))return new Map(a);if(s(a))return new Set(a);if(Array.isArray(a))return Array.prototype.slice.call(a);let c=m(a);if(!0!==b&&("class_only"!==b||c)){let b=i(a);return null!==b&&c?{...a}:Object.assign(Object.create(b),a)}{let b=Object.getOwnPropertyDescriptors(a);delete b[g];let c=Reflect.ownKeys(b);for(let d=0;d<c.length;d++){let e=c[d],f=b[e];!1===f.writable&&(f.writable=!0,f.configurable=!0),(f.get||f.set)&&(b[e]={configurable:!0,writable:!0,enumerable:f.enumerable,value:a[e]})}return Object.create(i(a),b)}}function v(a,b=!1){return x(a)||j(a)||!k(a)||(o(a)>1&&Object.defineProperties(a,{set:{value:w},add:{value:w},clear:{value:w},delete:{value:w}}),Object.freeze(a),b&&Object.values(a).forEach(a=>v(a,!0))),a}function w(){h(2)}function x(a){return Object.isFrozen(a)}var y={};function z(a){let b=y[a];return b||h(0,a),b}function A(a,b){b&&(z("Patches"),a.patches_=[],a.inversePatches_=[],a.patchListener_=b)}function B(a){C(a),a.drafts_.forEach(E),a.drafts_=null}function C(a){a===b&&(b=a.parent_)}function D(a){return b={drafts_:[],parent_:b,immer_:a,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function E(a){let b=a[g];0===b.type_||1===b.type_?b.revoke_():b.revoked_=!0}function F(a,b){b.unfinalizedDrafts_=b.drafts_.length;let c=b.drafts_[0];return void 0!==a&&a!==c?(c[g].modified_&&(B(b),h(4)),k(a)&&(a=G(b,a),b.parent_||I(b,a)),b.patches_&&z("Patches").generateReplacementPatches_(c[g].base_,a,b.patches_,b.inversePatches_)):a=G(b,c,[]),B(b),b.patches_&&b.patchListener_(b.patches_,b.inversePatches_),a!==e?a:void 0}function G(a,b,c){if(x(b))return b;let d=b[g];if(!d)return n(b,(e,f)=>H(a,d,b,e,f,c)),b;if(d.scope_!==a)return b;if(!d.modified_)return I(a,d.base_,!0),d.base_;if(!d.finalized_){d.finalized_=!0,d.scope_.unfinalizedDrafts_--;let b=d.copy_,e=b,f=!1;3===d.type_&&(e=new Set(b),b.clear(),f=!0),n(e,(e,g)=>H(a,d,b,e,g,c,f)),I(a,b,!1),c&&a.patches_&&z("Patches").generatePatches_(d,c,a.patches_,a.inversePatches_)}return d.copy_}function H(a,b,c,d,e,f,g){if(j(e)){let g=G(a,e,f&&b&&3!==b.type_&&!p(b.assigned_,d)?f.concat(d):void 0);if(q(c,d,g),!j(g))return;a.canAutoFreeze_=!1}else g&&c.add(e);if(k(e)&&!x(e)){if(!a.immer_.autoFreeze_&&a.unfinalizedDrafts_<1)return;G(a,e),(!b||!b.scope_.parent_)&&"symbol"!=typeof d&&(r(c)?c.has(d):Object.prototype.propertyIsEnumerable.call(c,d))&&I(a,e)}}function I(a,b,c=!1){!a.parent_&&a.immer_.autoFreeze_&&a.canAutoFreeze_&&v(b,c)}var J={get(a,b){if(b===g)return a;let c=t(a);if(!p(c,b)){var d=a,e=c,f=b;let g=M(e,f);return g?"value"in g?g.value:g.get?.call(d.draft_):void 0}let h=c[b];return a.finalized_||!k(h)?h:h===L(a.base_,b)?(O(a),a.copy_[b]=P(h,a)):h},has:(a,b)=>b in t(a),ownKeys:a=>Reflect.ownKeys(t(a)),set(a,b,c){let d=M(t(a),b);if(d?.set)return d.set.call(a.draft_,c),!0;if(!a.modified_){let d=L(t(a),b),e=d?.[g];if(e&&e.base_===c)return a.copy_[b]=c,a.assigned_[b]=!1,!0;if((c===d?0!==c||1/c==1/d:c!=c&&d!=d)&&(void 0!==c||p(a.base_,b)))return!0;O(a),N(a)}return!!(a.copy_[b]===c&&(void 0!==c||b in a.copy_)||Number.isNaN(c)&&Number.isNaN(a.copy_[b]))||(a.copy_[b]=c,a.assigned_[b]=!0,!0)},deleteProperty:(a,b)=>(void 0!==L(a.base_,b)||b in a.base_?(a.assigned_[b]=!1,O(a),N(a)):delete a.assigned_[b],a.copy_&&delete a.copy_[b],!0),getOwnPropertyDescriptor(a,b){let c=t(a),d=Reflect.getOwnPropertyDescriptor(c,b);return d?{writable:!0,configurable:1!==a.type_||"length"!==b,enumerable:d.enumerable,value:c[b]}:d},defineProperty(){h(11)},getPrototypeOf:a=>i(a.base_),setPrototypeOf(){h(12)}},K={};function L(a,b){let c=a[g];return(c?t(c):a)[b]}function M(a,b){if(!(b in a))return;let c=i(a);for(;c;){let a=Object.getOwnPropertyDescriptor(c,b);if(a)return a;c=i(c)}}function N(a){!a.modified_&&(a.modified_=!0,a.parent_&&N(a.parent_))}function O(a){a.copy_||(a.copy_=u(a.base_,a.scope_.immer_.useStrictShallowCopy_))}function P(a,c){let d=r(a)?z("MapSet").proxyMap_(a,c):s(a)?z("MapSet").proxySet_(a,c):function(a,c){let d=Array.isArray(a),e={type_:+!!d,scope_:c?c.scope_:b,modified_:!1,finalized_:!1,assigned_:{},parent_:c,base_:a,draft_:null,copy_:null,revoke_:null,isManual_:!1},f=e,g=J;d&&(f=[e],g=K);let{revoke:h,proxy:i}=Proxy.revocable(f,g);return e.draft_=i,e.revoke_=h,i}(a,c);return(c?c.scope_:b).drafts_.push(d),d}n(J,(a,b)=>{K[a]=function(){return arguments[0]=arguments[0][0],b.apply(this,arguments)}}),K.deleteProperty=function(a,b){return K.set.call(this,a,b,void 0)},K.set=function(a,b,c){return J.set.call(this,a[0],b,c,a[0])};var Q=new class{constructor(a){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(a,b,c)=>{let d;if("function"==typeof a&&"function"!=typeof b){let c=b;b=a;let d=this;return function(a=c,...e){return d.produce(a,a=>b.call(this,a,...e))}}if("function"!=typeof b&&h(6),void 0!==c&&"function"!=typeof c&&h(7),k(a)){let e=D(this),f=P(a,void 0),g=!0;try{d=b(f),g=!1}finally{g?B(e):C(e)}return A(e,c),F(d,e)}if(a&&"object"==typeof a)h(1,a);else{if(void 0===(d=b(a))&&(d=a),d===e&&(d=void 0),this.autoFreeze_&&v(d,!0),c){let b=[],e=[];z("Patches").generateReplacementPatches_(a,d,b,e),c(b,e)}return d}},this.produceWithPatches=(a,b)=>{let c,d;return"function"==typeof a?(b,...c)=>this.produceWithPatches(b,b=>a(b,...c)):[this.produce(a,b,(a,b)=>{c=a,d=b}),c,d]},"boolean"==typeof a?.autoFreeze&&this.setAutoFreeze(a.autoFreeze),"boolean"==typeof a?.useStrictShallowCopy&&this.setUseStrictShallowCopy(a.useStrictShallowCopy)}createDraft(a){var b;k(a)||h(8),j(a)&&(j(b=a)||h(10,b),a=function a(b){let c;if(!k(b)||x(b))return b;let d=b[g];if(d){if(!d.modified_)return d.base_;d.finalized_=!0,c=u(b,d.scope_.immer_.useStrictShallowCopy_)}else c=u(b,!0);return n(c,(b,d)=>{q(c,b,a(d))}),d&&(d.finalized_=!1),c}(b));let c=D(this),d=P(a,void 0);return d[g].isManual_=!0,C(c),d}finishDraft(a,b){let c=a&&a[g];c&&c.isManual_||h(9);let{scope_:d}=c;return A(d,b),F(void 0,d)}setAutoFreeze(a){this.autoFreeze_=a}setUseStrictShallowCopy(a){this.useStrictShallowCopy_=a}applyPatches(a,b){let c;for(c=b.length-1;c>=0;c--){let d=b[c];if(0===d.path.length&&"replace"===d.op){a=d.value;break}}c>-1&&(b=b.slice(c+1));let d=z("Patches").applyPatches_;return j(a)?d(a,b):this.produce(a,a=>d(a,b))}}().produce,R=a.i(32496),S=a.i(4655),T=a.i(24647),U=a.i(72571),V=a.i(84476),W=a.i(88206),X=a.i(328),Y=a.i(84850),Z=a.i(20094);function $(a){return(a=a.replace(/\s+/g," ").trim())?a.split(/(\s+|[.,!?;:\-â€”()"'â€œâ€â€žÂ«Â»â€¦])/).filter(a=>null!=a&&""!==a).filter(a=>a.trim().length>0||" "===a):[]}function _(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}let aa=(a,b)=>{let d=$(a),e=$(b),{matchesB:f}=function(a,b){let c=a.length,d=b.length,e=Array.from({length:c+1},()=>Array(d+1).fill(0));for(let f=c-1;f>=0;f--)for(let c=d-1;c>=0;c--)a[f]===b[c]?e[f][c]=1+e[f+1][c+1]:e[f][c]=Math.max(e[f+1][c],e[f][c+1]);let f=0,g=0,h=[];for(;f<c&&g<d;)a[f]===b[g]?(h.push(g),f++,g++):e[f+1][g]>=e[f][g+1]?f++:g++;return{matchesB:h}}(d,e),g=new Set(f);return e.map((a,b)=>g.has(b)?(0,c.jsx)("span",{children:_(a)},b):(0,c.jsx)("span",{style:{background:"#ffeb3b"},children:_(a)},b))};var ab=a.i(5050),ac=(0,ab.createServerReference)("60ade2cbc88de963dd9e3bf7db6de6b8236faf3555",ab.callServer,void 0,ab.findSourceMapURL,"removeAudio"),ad=(0,ab.createServerReference)("4070ea98a11628a94cc0f0fac01ab622e1a5cbc950",ab.callServer,void 0,ab.findSourceMapURL,"removeSentence"),ae=a.i(24195);let af="blobs";function ag(){return new Promise((a,b)=>{let c=indexedDB.open("audio-store",1);c.onupgradeneeded=a=>{let b=a.target.result;b.objectStoreNames.contains(af)||b.createObjectStore(af,{keyPath:"uuid"})},c.onsuccess=()=>{a(c.result)},c.onerror=()=>{b(c.error)}})}async function ah(a,b){let c=await ag();return new Promise((d,e)=>{let f=c.transaction(af,"readwrite").objectStore(af),g={uuid:a,audioBlob:b,createdAt:Date.now()},h=f.put(g);h.onsuccess=()=>d(),h.onerror=()=>e(h.error)})}async function ai(a){let b=await ag();return new Promise((c,d)=>{let e=b.transaction(af,"readonly").objectStore(af).get(a);e.onsuccess=()=>{let a=e.result;c(a?a.audioBlob:null)},e.onerror=()=>d(e.error)})}async function aj(a){let b=await ag();return new Promise((c,d)=>{let e=b.transaction(af,"readwrite").objectStore(af).delete(a);e.onsuccess=()=>c(),e.onerror=()=>d(e.error)})}let ak=new Map,al=new FinalizationRegistry(a=>{ak.delete(a)});function am(a,b){if("undefined"==typeof WeakRef)return;let c=new WeakRef(b);ak.set(a,c);try{al.register(b,a,b)}catch(a){console.log(a)}}function an(a){let b=ak.get(a);if(!b)return null;let c=b.deref();return c||(ak.delete(a),null)}function ao(a){ak.delete(a)}function ap({item:a,engine:b,onUpdate:e,onDelete:f}){let[g,h]=(0,d.useState)(!1),[i,j]=(0,d.useState)(!1),[k,l]=(0,d.useState)(!1),[m,n]=(0,d.useState)(!1),o=(0,d.useRef)([]),p=(0,d.useRef)(null),q=async()=>{let c=async(b,c)=>{"success"===b.status?(await ah(a.uuid,c),am(a.uuid,c),e({...a,recognized:b.data,modified_db:!0,modified_fs:!0})):Z.toast.error(b.error)};a.modified_fs&&(await aj(a.uuid),ao(a.uuid)),await (0,Y.toggleRecording)(g,h,o,p,!0,b,j,a=>{console.log(a)},c)},r=async()=>{if(a.modified_fs&&(await aj(a.uuid),ao(a.uuid)),a.on_fs){if("success"!==(await ac("reading",`${a.uuid}.wav`)).status)return void Z.toast.error("delete audio failed");Z.toast.success("delete audio success")}if(a.in_db){if("success"!==(await ad(a.uuid)).status)return void Z.toast.error("delete sentence failed");Z.toast.success("delete sentence success")}f(a.uuid)};return(0,c.jsxs)("div",{className:"flex flex-col items-start justify-start w-full rounded-lg bg-sand-300",children:[(0,c.jsxs)("div",{className:"flex flex-row items-start justify-start w-full my-2",children:[a.modified_db||a.modified_fs?(0,c.jsx)(W.Tooltip,{placement:"bottom",content:"unsaved",children:(0,c.jsx)("div",{className:"text-red-500",children:"â—"})}):(0,c.jsx)("div",{className:"text-transparent",children:"â—"}),(0,c.jsxs)("div",{className:"flex flex-col w-full ps-2",children:[(0,c.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,c.jsxs)("div",{className:"flex flex-row items-center justify-start w-full",children:[(0,c.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,c.jsx)(W.Tooltip,{placement:"top",content:"re-record",children:(0,c.jsx)(R.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:!g&&i,onPress:q,children:g?(0,c.jsx)(X.MdMic,{size:20}):(0,c.jsx)(X.MdMicOff,{size:20})})}),(0,c.jsx)(W.Tooltip,{placement:"top",content:"play audio",children:(0,c.jsx)(R.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{if(a.modified_fs){let b=an(a.uuid);if(b||((b=await ai(a.uuid))?am(a.uuid,b):Z.toast.error("Blob of audio not found")),b){let a=URL.createObjectURL(b),c=new Audio(a);c.play(),c.onended=()=>{URL.revokeObjectURL(a)}}}else new Audio(a.audio_path).play()},children:(0,c.jsx)(X.MdPlayCircle,{size:20})})})]}),(0,c.jsxs)("div",{className:"flex flex-row items-center justify-end",children:[(0,c.jsx)(W.Tooltip,{placement:"top",content:"show/hide original",children:(0,c.jsx)(R.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>n(!m),children:m?(0,c.jsx)(X.MdOutlineKeyboardDoubleArrowUp,{size:20}):(0,c.jsx)(X.MdOutlineKeyboardDoubleArrowDown,{size:20})})}),(0,c.jsx)(W.Tooltip,{placement:"top",content:"delete",children:(0,c.jsx)(R.Button,{isIconOnly:!0,variant:"light",color:"danger",className:"w-fit h-fit",onPress:()=>{window.confirm("Are you sure to delete?")&&r()},children:(0,c.jsx)(X.MdDelete,{size:20})})})]})]}),(0,c.jsx)("div",{className:"text-xl text-balance hyphens-auto",children:aa(a.original,a.recognized)})]}),(0,c.jsxs)("div",{className:"flex flex-col items-center justify-center w-fit gap-1",children:[(0,c.jsx)(W.Tooltip,{placement:"left",content:"move upward",children:(0,c.jsx)(R.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{e({...a,order_num:a.order_num+1,modified_db:!0})},children:(0,c.jsx)(X.MdArrowUpward,{size:20})})}),(0,c.jsx)("div",{children:a.order_num}),(0,c.jsx)(W.Tooltip,{placement:"left",content:"move downward",children:(0,c.jsx)(R.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:()=>{e({...a,order_num:a.order_num-1,modified_db:!0})},children:(0,c.jsx)(X.MdArrowDownward,{size:20})})})]})]}),m&&(0,c.jsx)("div",{className:"flex flex-row items-center justify-start w-full px-2 pb-1",children:(0,c.jsx)(V.Textarea,{size:"lg",className:"w-full",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:a.original,onChange:b=>{e({...a,original:b.target.value,modified_db:!0})},endContent:(0,c.jsx)(R.Button,{isIconOnly:!0,variant:"light",className:"h-fit",isDisabled:k,onPress:async()=>{let b=`/api/data/tts/${a.uuid}.wav`;if(!await fetch(b,{method:"HEAD"}).then(a=>a.ok).catch(()=>!1)){l(!0);let b=await (0,ae.callTTS)(a.uuid,a.original);if(l(!1),"error"===b.status)return void console.error(b.error)}new Audio(b).play().catch(a=>console.error("error: ",a))},children:(0,c.jsx)(X.MdPlayCircle,{size:20})})})})]})}var aq=a.i(68114),ar=(0,ab.createServerReference)("4019ff06c8f23449407a073d16f6cef7604480b33b",ab.callServer,void 0,ab.findSourceMapURL,"getBookAll"),as=a.i(7166),at=a.i(11736),au=a.i(27493),av=a.i(75090);function aw({user_id:a,onSelect:b}){let[e,f]=(0,d.useState)([]),[g,h]=(0,d.useState)(""),[i,j]=(0,d.useState)(!1),[k,l]=(0,d.useState)(!1),[m,n]=(0,d.useState)(!1),o=async()=>{n(!0);let b=await ar(a);"success"===b.status&&f(b.data),n(!1)},p=async()=>{if(!a)return void Z.toast.error("not logged in");l(!0),"success"===(await (0,at.saveBook)({uuid:(0,aq.getUUID)(),user_id:a,name:g,created_by:a,created_at:new Date,updated_at:new Date})).status?(Z.toast.success("save book success"),h("")):Z.toast.error("save book failed"),l(!1)},q=async a=>{l(!0),"success"===(await (0,as.removeBook)(a)).status?Z.toast.success("delete book success"):Z.toast.error("delete book failed"),l(!1)};return(0,d.useEffect)(()=>{o()},[a]),(0,c.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,c.jsx)(S.Select,{label:"Select book",onChange:async a=>{let c=a.target.value;await b(c)},endContent:m&&(0,c.jsx)(au.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:e.map(a=>(0,c.jsx)(T.SelectItem,{textValue:a.name,children:a.name},a.uuid))}),(0,c.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,c.jsx)(R.Button,{size:"sm",radius:"full",onPress:()=>j(!i),children:i?"finish":"edit"}),(0,c.jsx)(R.Button,{size:"sm",radius:"full",onPress:o,children:"refresh"})]}),i&&(0,c.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,c.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,c.jsx)(av.Input,{label:"Name of Book",size:"sm",onChange:a=>h(a.target.value)}),(0,c.jsx)(R.Button,{size:"sm",radius:"full",isDisabled:k,onPress:p,children:"add"})]}),e.map(a=>(0,c.jsxs)("div",{className:"flex flex-row items-center justify-start px-2 gap-2 bg-sand-300",children:[a.name,(0,c.jsx)(R.Button,{size:"sm",radius:"full",onPress:()=>q(a.uuid),children:"delete"})]},a.uuid))]})]})}var ax=(0,ab.createServerReference)("4061691617956344a16be9f87508af526badba2aa9",ab.callServer,void 0,ab.findSourceMapURL,"getSentenceAll"),ay=(0,ab.createServerReference)("409e8fe1593fa624f1e9c3a04b17811f242b7bd429",ab.callServer,void 0,ab.findSourceMapURL,"saveSentence"),az=(0,ab.createServerReference)("40b5cb9e98dbf5283e5cf4af8aca2b095b382fe276",ab.callServer,void 0,ab.findSourceMapURL,"getChapterAll"),aA=(0,ab.createServerReference)("4061d304fce5063405aaa75978c547033a8e45ada7",ab.callServer,void 0,ab.findSourceMapURL,"removeChapter"),aB=(0,ab.createServerReference)("40b7e7a46205ce36825f53c7350886a6df63a9a459",ab.callServer,void 0,ab.findSourceMapURL,"saveChapter");function aC({user_id:a,book_uuid:b,onSelect:e}){let[f,g]=(0,d.useState)([]),[h,i]=(0,d.useState)(""),[j,k]=(0,d.useState)(""),[l,m]=(0,d.useState)(!1),[n,o]=(0,d.useState)(!1),[p,q]=(0,d.useState)(!1),r=async()=>{q(!0);let a=await az(b);"success"===a.status&&g(a.data),q(!1)},s=async()=>a?b?void(o(!0),"success"===(await aB({uuid:(0,aq.getUUID)(),book_uuid:b,order_num:parseInt(h,10),name:j,created_by:a,created_at:new Date,updated_at:new Date})).status?(Z.toast.success("save chapter success"),k("")):Z.toast.error("save chapter failed"),o(!1)):void Z.toast.error("no book selected"):void Z.toast.error("not logged in"),t=async a=>{o(!0),"success"===(await aA(a)).status?Z.toast.success("delete chapter success"):Z.toast.error("delete chapter failed"),o(!1)};return(0,d.useEffect)(()=>{r()},[b]),(0,c.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,c.jsx)(S.Select,{label:"Select chapter",onChange:async a=>{let b=a.target.value;await e(b)},endContent:p&&(0,c.jsx)(au.CircularProgress,{"aria-label":"Loading...",color:"default"}),children:f.map(a=>(0,c.jsxs)(T.SelectItem,{textValue:`${a.order_num}, ${a.name}`,children:[a.order_num,", ",a.name]},a.uuid))}),(0,c.jsxs)("div",{className:"flex flex-row gap-1",children:[(0,c.jsx)(R.Button,{size:"sm",radius:"full",onPress:()=>m(!l),children:l?"finish":"edit"}),(0,c.jsx)(R.Button,{size:"sm",radius:"full",onPress:r,children:"refresh"})]}),l&&(0,c.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,c.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2",children:[(0,c.jsx)(av.Input,{label:"Order",type:"number",size:"sm",className:"w-1/5",onChange:a=>i(a.target.value)}),(0,c.jsx)(av.Input,{label:"Name of Book",size:"sm",onChange:a=>k(a.target.value)}),(0,c.jsx)(R.Button,{size:"sm",radius:"full",isDisabled:n,onPress:s,children:"add"})]}),f.map(a=>(0,c.jsxs)("div",{className:"flex flex-row items-center justify-start gap-2 bg-sand-300",children:[a.order_num," - ",a.name,(0,c.jsx)(R.Button,{size:"sm",radius:"full",onPress:()=>t(a.uuid),children:"delete"})]},a.uuid))]})]})}var aD=(0,ab.createServerReference)("70b4b17c08b7b4c986dc5771a85935021682710340",ab.callServer,void 0,ab.findSourceMapURL,"saveAudio");function aE({email:a}){var b,e,f;let[g,h]=(0,d.useState)(""),[i,j]=(0,d.useState)(""),[k,l]=(0,d.useState)("local"),[m,n]=(0,d.useState)(!1),[o,p]=(0,d.useState)(!1),[q,r]=(0,d.useState)(),[s,t]=(b=[],f=(e=(0,d.useState)(function(){return v("function"==typeof b?b():b,!0)}))[1],[e[0],(0,d.useCallback)(function(a){f("function"==typeof a?Q(a):v(a))},[])]),[u,w]=(0,d.useState)(!1),[x,y]=(0,d.useState)(!1),[z,A]=(0,d.useState)(!1),B=(0,d.useRef)([]),C=(0,d.useRef)(null),D=(0,d.useMemo)(()=>s.slice().reverse(),[s]),E=async a=>{y(!0);let b=await ax(a);if("success"===b.status){let a=b.data.map((a,b)=>(a.order_num!==b+1&&w(!0),{...(0,aq.toExactType)(a),order_num:b+1,in_db:!0,on_fs:!0,modified_db:a.order_num!==b+1,modified_fs:!1}));t(b=>{for(let c of(b.length=0,a))b.push(c)})}y(!1)},F=a=>{t(b=>{let c=b.findIndex(b=>b.uuid===a.uuid);if(-1!==c){if(b[c].order_num!==a.order_num){b.splice(c,1);let d=Math.max(0,Math.min(b.length,a.order_num-1));b.splice(d,0,{...a})}else b[c]={...a};b.forEach((a,b)=>{a.modified_db||a.order_num===b+1||(a.modified_db=a.order_num!==b+1),a.order_num=b+1})}}),w(!0)},G=a=>{t(b=>{let c=b.findIndex(b=>b.uuid===a);-1!==c&&b.splice(c,1),b.forEach((a,b)=>{a.modified_db||a.order_num===b+1||(a.modified_db=a.order_num!==b+1),a.order_num=b+1,a.order_num=b+1})}),w(!0)},H=async()=>{if(!q)return;A(!0);let b=an(q.uuid);if(b||(b=await ai(q.uuid)),!b){Z.toast.error("Blob of audio not found"),A(!1);return}if("success"===(await aD(b,"reading",`${q.uuid}.wav`)).status)await aj(q.uuid),ao(q.uuid);else{Z.toast.error("save audio failed"),A(!1);return}if("error"===(await ay({uuid:q.uuid,chapter_uuid:q.chapter_uuid,order_num:q.order_num,original:q.original,recognized:q.recognized,audio_path:`/api/data/reading/${q.uuid}.wav`,created_by:a,created_at:q.created_at||new Date,updated_at:new Date})).status){Z.toast.error("save db failed"),A(!1);return}t(a=>{a.push({...q,in_db:!0,on_fs:!0,modified_db:!1,modified_fs:!1})}),r(void 0),Z.toast.success("added and saved successfully!"),A(!1)},I=async()=>{A(!0);try{for(let b of s){if(b.modified_fs){let a=an(b.uuid);if(a||(a=await ai(b.uuid)),!a)throw Error(`${b.order_num}: Blob of audio not found`);let c=await aD(a,"reading",`${b.uuid}.wav`);if("success"===c.status)await aj(b.uuid),ao(b.uuid),t(a=>{let c=a.find(a=>a.uuid===b.uuid);c&&(c.on_fs=!0,c.modified_fs=!1)});else throw Error(`${b.order_num}: save audio failed`)}let c=await ay({uuid:b.uuid,chapter_uuid:b.chapter_uuid,order_num:b.order_num,original:b.original,recognized:b.recognized,audio_path:b.audio_path,created_by:a,created_at:b.created_at||new Date,updated_at:new Date});if("error"===c.status)throw Error("save sentence failed");t(a=>{let c=a.find(a=>a.uuid===b.uuid);c&&(c.in_db=!0,c.modified_db=!1)})}w(!1),Z.toast.success("All sentences saved successfully!")}catch(a){Z.toast.error(a.message||"Failed to save sentences")}A(!1)};return(0,d.useEffect)(()=>{let a=a=>{if(a.ctrlKey&&"a"===a.key){a.preventDefault();let b=document.getElementById("button-toggel-recording");b?.click()}if(a.ctrlKey&&"s"===a.key){a.preventDefault();let b=document.getElementById("button-add-save");b?.click()}};return document.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},[m,o]),(0,c.jsxs)("div",{children:[(0,c.jsxs)("div",{className:"flex flex-col md:flex-row gap-4 my-4",children:[(0,c.jsx)(aw,{user_id:a,onSelect:async a=>{h(a)}}),(0,c.jsx)(aC,{user_id:a,book_uuid:g,onSelect:async a=>{j(a),r(void 0),w(!1),await E(a)}})]}),(0,c.jsxs)("div",{className:"flex flex-row items-center justify-center gap-4 my-4",children:[(0,c.jsx)(S.Select,{className:"max-w-sm",selectedKeys:[k],onChange:a=>l(a.target.value),startContent:(0,c.jsx)("div",{className:"whitespace-nowrap font-bold",children:"AI Engine"}),children:Y.EngineList.map(a=>(0,c.jsx)(T.SelectItem,{textValue:a.value,children:a.value},a.key))}),(0,c.jsx)(R.Button,{variant:"solid",color:"primary",id:"button-toggel-recording",isDisabled:!m&&o,onPress:()=>{if(g&&i){q&&r(void 0);let a=async(a,b)=>{if("success"===a.status){let c=(0,aq.getUUID)();await ah(c,b),am(c,b),r({uuid:c,chapter_uuid:i,order_num:s.length+1,original:a.data,recognized:a.data,audio_path:`/api/data/reading/${c}.wav`,in_db:!1,on_fs:!1,modified_db:!0,modified_fs:!0})}else Z.toast.error(a.error)};(0,Y.toggleRecording)(m,n,B,C,!0,k,p,a=>{console.log(a)},a)}else alert("select book and chapter first")},children:m?"â¹ Stop Recording (Ctrl+A)":o?"Processing":"ðŸŽ¤ Read a Sentence (Ctrl+A)"})]}),q&&(0,c.jsxs)("div",{className:"flex flex-col items-center justify-center w-full gap-2 my-4",children:[(0,c.jsxs)("div",{className:"flex flex-col w-full p-2 rounded-lg bg-sand-300",children:[(0,c.jsxs)("div",{className:"flex flex-row items-center justify-start",children:[(0,c.jsx)("div",{className:"text-md text-gray-400",children:"recognized from audio:"}),(0,c.jsx)(R.Button,{isIconOnly:!0,variant:"light",className:"h-fit",onPress:async()=>{let a=an(q.uuid);if(a||((a=await ai(q.uuid))?am(q.uuid,a):Z.toast.error("Blob of audio not found")),a){let b=URL.createObjectURL(a),c=new Audio(b);c.play(),c.onended=()=>{URL.revokeObjectURL(b)}}},children:(0,c.jsx)(X.MdPlayCircle,{size:20})})]}),(0,c.jsx)("div",{className:"text-xl",children:aa(q.original,q.recognized)}),(0,c.jsx)(V.Textarea,{size:"lg",className:"w-full",label:"original text",classNames:{inputWrapper:"bg-sand-200",input:"text-xl"},defaultValue:q.original,onChange:a=>r({...q,original:a.target.value})})]}),(0,c.jsx)(R.Button,{variant:"solid",color:"primary",id:"button-add-save",isDisabled:z,onPress:H,children:"Add & Save (Ctrl+S)"})]}),x&&(0,c.jsx)("div",{className:"flex flex-row w-full items-center justify-center gap-4 my-4",children:(0,c.jsx)(U.Spinner,{classNames:{label:"text-foreground mt-4"},variant:"simple"})}),u&&(0,c.jsx)("div",{className:"flex flex-row items-center justify-end my-4 mb-0",children:(0,c.jsx)(R.Button,{variant:"solid",color:"primary",isDisabled:z,onPress:I,children:"Save"})}),s.length>0&&(0,c.jsx)("div",{className:"flex flex-col w-full gap-4 my-4",children:D.map((a,b)=>(0,c.jsx)(ap,{item:a,engine:k,onUpdate:F,onDelete:G},`${b}-${a.uuid}`))})]})}}];

//# sourceMappingURL=src_app_speak_read_reading_tsx_4a53dc60._.js.map